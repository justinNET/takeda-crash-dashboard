<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Takeda DS Player Crash Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0a0f1e;--surface:rgba(255,255,255,0.03);--border:rgba(255,255,255,0.07);
    --text:#e2e8f0;--muted:#94a3b8;--dim:#64748b;
    --red:#ef4444;--orange:#f97316;--yellow:#eab308;--green:#22c55e;--blue:#3b82f6;--purple:#a855f7;--cyan:#06b6d4;
    --indigo:#4f46e5;
  }
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',system-ui,sans-serif;min-height:100vh}
  .header{background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 100%);border-bottom:1px solid rgba(99,102,241,0.2);padding:24px 32px}
  .header-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
  .live-dot{width:9px;height:9px;border-radius:50%;background:var(--red);box-shadow:0 0 10px var(--red);animation:pulse 2s infinite;display:inline-block;margin-right:8px}
  .live-label{font-size:11px;font-family:'DM Mono',monospace;color:var(--red);letter-spacing:2px;text-transform:uppercase}
  h1{font-size:26px;font-weight:800;letter-spacing:-0.5px;margin-top:6px}
  .header-sub{font-size:12px;color:var(--dim);margin-top:3px}
  .header-count{text-align:right}
  .big-num{font-size:48px;font-weight:900;color:var(--red);font-family:'DM Mono',monospace;line-height:1}
  .big-label{font-size:12px;color:var(--dim)}
  .last-updated{font-size:11px;color:var(--dim);margin-top:4px;font-family:'DM Mono',monospace}
  .tabs-wrap{max-width:1100px;margin:0 auto;padding:28px 32px 0}
  .tabs{display:flex;gap:4px;background:rgba(255,255,255,0.03);border-radius:10px;padding:4px;width:fit-content;margin-bottom:28px}
  .tab{padding:8px 20px;border-radius:7px;border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all 0.2s;background:transparent;color:var(--dim)}
  .tab.active{background:rgba(99,102,241,0.25);color:#a5b4fc}
  .content{display:none;max-width:1100px;margin:0 auto;padding:0 32px 60px}
  .content.active{display:block}
  .stat-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:28px}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 22px;flex:1;min-width:130px}
  .stat-val{font-size:34px;font-weight:800;font-family:'DM Mono',monospace;letter-spacing:-1px}
  .stat-label{font-size:12px;color:var(--muted);margin-top:3px;font-weight:500}
  .stat-sub{font-size:11px;color:var(--dim);margin-top:2px}
  .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-bottom:22px}
  .chart-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px}
  .chart-title{font-size:12px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:18px}
  .legend{display:flex;flex-direction:column;gap:7px;margin-top:14px}
  .legend-item{display:flex;align-items:center;gap:9px}
  .legend-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
  .legend-label{font-size:12px;color:var(--muted);flex:1}
  .legend-val{font-size:13px;font-weight:700;font-family:'DM Mono',monospace}
  .alert{padding:10px 14px;border-radius:8px;font-size:12px;margin-top:12px}
  .alert-orange{background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);color:#fdba74}
  .alert-indigo{background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);color:#a5b4fc}
  .alert-green{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);color:#86efac}
  .table-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-top:22px}
  table{width:100%;border-collapse:collapse}
  thead tr{background:rgba(255,255,255,0.05)}
  th{padding:11px 15px;text-align:left;font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:700}
  td{padding:11px 15px;font-size:13px;border-top:1px solid rgba(255,255,255,0.04)}
  tr:nth-child(even){background:rgba(255,255,255,0.01)}
  .mono{font-family:'DM Mono',monospace}
  .badge{font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px}
  .finding{border-radius:13px;padding:22px;margin-bottom:14px;cursor:pointer;transition:all 0.2s}
  .finding:hover{filter:brightness(1.05)}
  .finding-header{display:flex;align-items:flex-start;gap:14px}
  .finding-icon{font-size:26px;flex-shrink:0}
  .finding-body{flex:1}
  .finding-severity{font-size:11px;font-weight:800;padding:3px 10px;border-radius:4px;letter-spacing:1px;display:inline-block;margin-bottom:8px}
  .finding-count{font-size:12px;color:var(--dim);font-family:'DM Mono',monospace;margin-left:10px}
  .finding-title{font-size:16px;font-weight:700;color:#f1f5f9;margin-bottom:7px}
  .finding-detail{font-size:13px;color:var(--muted);line-height:1.65}
  .finding-toggle{font-size:12px;color:var(--dim);margin-top:10px}
  .steps{margin-top:14px;padding:15px 18px;background:rgba(0,0,0,0.3);border-radius:9px;border:1px solid rgba(255,255,255,0.05);display:none}
  .steps.open{display:block}
  .steps-title{font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
  .step{display:flex;gap:10px;margin-bottom:9px;align-items:flex-start}
  .step-num{width:22px;height:22px;border-radius:50%;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
  .step-text{font-size:13px;color:#cbd5e1;line-height:1.6}
  .ai-box{background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:13px;padding:22px;margin-bottom:22px}
  .ai-title{font-size:16px;font-weight:700;color:#a5b4fc;margin-bottom:6px}
  .ai-sub{font-size:13px;color:var(--dim);margin-bottom:16px}
  .ai-input-row{display:flex;gap:10px}
  .ai-input{flex:1;padding:11px 15px;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);font-size:13px;font-family:'DM Sans',sans-serif;outline:none}
  .ai-input:focus{border-color:rgba(99,102,241,0.5)}
  .ai-btn{padding:11px 22px;background:var(--indigo);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;font-family:'DM Sans',sans-serif}
  .ai-btn:disabled{background:#334155;cursor:not-allowed}
  .quick-prompts{display:flex;gap:7px;margin-top:11px;flex-wrap:wrap}
  .qp{padding:6px 11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.09);border-radius:6px;color:var(--muted);font-size:11px;cursor:pointer;font-family:'DM Sans',sans-serif}
  .qp:hover{background:rgba(255,255,255,0.09);color:var(--text)}
  .ai-response{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:22px}
  .ai-response-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:12px}
  .ai-response-text{font-size:14px;color:#cbd5e1;line-height:1.8;white-space:pre-wrap}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;margin-right:6px;vertical-align:middle}
  .loading-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;gap:16px}
  .loading-spinner{width:40px;height:40px;border:3px solid rgba(99,102,241,0.2);border-top-color:#4f46e5;border-radius:50%;animation:spin 1s linear infinite}
  .loading-text{font-size:14px;color:var(--dim)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <div><span class="live-dot"></span><span class="live-label">Live Data</span></div>
      <h1>Takeda DS Player Crash Intelligence</h1>
      <div class="header-sub" id="headerSub">Loading data...</div>
    </div>
    <div class="header-count">
      <div class="big-num" id="headerTotal">â€”</div>
      <div class="big-label">total crash events</div>
      <div class="last-updated" id="lastUpdated"></div>
    </div>
  </div>
</div>

<div class="tabs-wrap">
  <div class="tabs">
    <button class="tab active" onclick="switchTab('overview',this)">Overview</button>
    <button class="tab" onclick="switchTab('machines',this)">Machines</button>
    <button class="tab" onclick="switchTab('fixes',this)">Findings &amp; Fixes</button>
    <button class="tab" onclick="switchTab('ai',this)">ğŸ¤– AI Assist</button>
  </div>
</div>

<div id="tab-overview" class="content active">
  <div id="overviewLoading" class="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Fetching live crash data from SharePoint...</div>
  </div>
  <div id="overviewContent" style="display:none">
    <div class="stat-row" id="statRow"></div>
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-title">Event Type Breakdown</div>
        <div style="height:180px"><canvas id="donutChart"></canvas></div>
        <div class="legend" id="donutLegend"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Crash Timeline</div>
        <div style="height:220px"><canvas id="timelineChart"></canvas></div>
      </div>
    </div>
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-title">BIOS Version Distribution</div>
        <div style="height:140px"><canvas id="biosChart"></canvas></div>
        <div class="alert alert-orange" id="biosAlert"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">OS Build Distribution</div>
        <div style="height:140px"><canvas id="osChart"></canvas></div>
        <div class="alert alert-indigo">â„¹ï¸ Both OS builds equally affected â€” not an OS version issue</div>
      </div>
    </div>
  </div>
</div>

<div id="tab-machines" class="content">
  <div class="chart-card" style="margin-bottom:22px">
    <div class="chart-title">Crashes Per Machine</div>
    <div style="height:300px"><canvas id="machineChart"></canvas></div>
  </div>
  <div class="table-card">
    <table>
      <thead><tr><th>Hostname</th><th>Crashes</th><th>Risk</th><th>BIOS</th><th>OS Build</th><th>Action Needed</th></tr></thead>
      <tbody id="machineTableBody"></tbody>
    </table>
  </div>
</div>

<div id="tab-fixes" class="content">
  <div class="alert alert-indigo" style="margin-bottom:20px" id="findingsHeader"></div>
  <div id="findingsContainer"></div>
</div>

<div id="tab-ai" class="content">
  <div class="ai-box">
    <div class="ai-title">ğŸ¤– Ask AI About Your Crash Data</div>
    <div class="ai-sub">Claude has full context of your live crash data. Ask anything about remediation, patterns, or next steps.</div>
    <div class="ai-input-row">
      <input id="aiInput" class="ai-input" type="text" placeholder="e.g. Which machines should I prioritize? Write a GoTo Resolve BIOS update script..." onkeydown="if(event.key==='Enter')askAI()">
      <button class="ai-btn" id="aiBtn" onclick="askAI()">Ask</button>
    </div>
    <div class="quick-prompts">
      <button class="qp" onclick="setQ('Which machines are at highest risk of full OS failure?')">Which machines are highest risk?</button>
      <button class="qp" onclick="setQ('Write a PowerShell script to run sfc /scannow on machines that triggered Startup Repair')">Write SFC repair script</button>
      <button class="qp" onclick="setQ('What caused the crash cluster and how do I prevent it?')">Explain crash cluster</button>
      <button class="qp" onclick="setQ('What BIOS settings should I change for better crash recovery?')">BIOS settings to change</button>
    </div>
  </div>
  <div id="aiResponseBox" style="display:none" class="ai-response">
    <div class="ai-response-label">AI Response</div>
    <div id="aiResponseText" class="ai-response-text"></div>
  </div>
</div>

<script>
// â”€â”€â”€ GIST API URL - Uses GitHub API to bypass CDN caching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Raw URL caches aggressively and ignores cache busters. API always returns latest.
const GIST_ID = 'ad4d325dd588c805fb43c754afcac062';
const GIST_URL = `https://api.github.com/gists/${GIST_ID}`;

// â”€â”€â”€ FALLBACK DATA (used until Gist is set up) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FALLBACK = {
  total: 73, uniqueMachines: 12, lastUpdated: "2026-02-26T17:00:00Z",
  eventIds: {"41":34,"6008":34,"1001":5},
  crashesPerMachine: {"DSD-29ZFWV3":12,"DSD-J9ZFWV3":11,"DSD-F9ZFWV3":9,"DSD-D9ZFWV3":8,"DSD-2BZFWV3":6,"DSD-GQV9B24":6,"DSD-FRV9B24":5,"DSD-C9ZFWV3":4,"DSD-FSV9B24":4,"DSD-G9ZFWV3":4,"DSD-1BZFWV3":2,"DSD-HS225K3":2},
  biosVersions: {"1.30.0":27,"1.33.0":44,"2.27.0":2},
  osBuilds: {"26100":33,"26200":40},
  outdatedBiosCount: 27, outdatedBiosPct: 37,
  startupRepairMachines: ["DSD-29ZFWV3","DSD-J9ZFWV3","DSD-F9ZFWV3","DSD-FRV9B24"],
  topCrasher: {host:"DSD-29ZFWV3", count:12},
  biosOutdatedMachines: ["DSD-29ZFWV3","DSD-F9ZFWV3","DSD-2BZFWV3"],
  timeline: {"Jan 29":12,"Feb 2":8,"Feb 5":4,"Feb 6":6,"Feb 9":3,"Feb 10":2,"Feb 14":8,"Feb 16":4,"Feb 17":10,"Feb 18":6,"Feb 19":4,"Feb 20":8,"Feb 23":3,"Feb 24":5,"Feb 26":6}
};

// â”€â”€â”€ PROCESS RAW ITEMS FROM SHAREPOINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// When the Gist contains a full items array, compute all aggregations here
function processItems(raw) {
  const items = raw.items || [];
  if (!items.length) return null;

  const total = items.length;

  // Unique machines by Hostname
  const machineMap = {};
  items.forEach(r => {
    const h = r.Hostname || r.Title || 'Unknown';
    machineMap[h] = (machineMap[h] || 0) + 1;
  });
  const uniqueMachines = Object.keys(machineMap).length;

  // Event ID breakdown from CrashMarkerEventID
  const eventIds = {};
  items.forEach(r => {
    const ev = r.CrashMarkerEventID || 'Unknown';
    eventIds[ev] = (eventIds[ev] || 0) + 1;
  });

  // BIOS versions
  const biosVersions = {};
  items.forEach(r => {
    const b = r.BIOSVersion || 'Unknown';
    biosVersions[b] = (biosVersions[b] || 0) + 1;
  });

  // OS builds
  const osBuilds = {};
  items.forEach(r => {
    const os = r.OSBuild || 'Unknown';
    osBuilds[os] = (osBuilds[os] || 0) + 1;
  });

  // Outdated BIOS = version 1.30.x
  const outdatedBiosMachines = [...new Set(
    items.filter(r => (r.BIOSVersion||'').startsWith('1.30')).map(r => r.Hostname || r.Title)
  )];
  const outdatedBiosCount = items.filter(r => (r.BIOSVersion||'').startsWith('1.30')).length;
  const outdatedBiosPct = Math.round((outdatedBiosMachines.length / uniqueMachines) * 100);

  // Startup repair machines = those with BugCheckCode or Event 1001
  const startupRepairMachines = [...new Set(
    items.filter(r => r.CrashMarkerEventID === '1001' || (r.BugCheckCode && r.BugCheckCode !== 'N/A' && r.BugCheckCode !== '')).map(r => r.Hostname || r.Title)
  )];

  // Timeline: group by date of CrashMarkerTime
  const timeline = {};
  items.forEach(r => {
    if (!r.CrashMarkerTime) return;
    const d = new Date(r.CrashMarkerTime);
    if (isNaN(d)) return;
    const label = (d.getMonth()+1) + '/' + d.getDate();
    timeline[label] = (timeline[label] || 0) + 1;
  });
  // Sort timeline by date
  const sortedTimeline = {};
  Object.keys(timeline).sort((a,b) => {
    const [am,ad] = a.split('/').map(Number);
    const [bm,bd] = b.split('/').map(Number);
    return am !== bm ? am - bm : ad - bd;
  }).forEach(k => sortedTimeline[k] = timeline[k]);

  // Top crasher
  const sortedMachines = Object.entries(machineMap).sort((a,b) => b[1]-a[1]);
  const topCrasher = sortedMachines[0] ? {host: sortedMachines[0][0], count: sortedMachines[0][1]} : {host:'N/A', count:0};

  return {
    total, uniqueMachines, lastUpdated: raw.lastUpdated,
    eventIds, crashesPerMachine: machineMap,
    biosVersions, osBuilds,
    outdatedBiosCount, outdatedBiosPct,
    outdatedBiosMachines, biosOutdatedMachines: outdatedBiosMachines,
    startupRepairMachines, topCrasher, timeline: sortedTimeline
  };
}

let DATA = FALLBACK;
let aiContext = '';
let donutChartInst, timelineChartInst, biosChartInst, osChartInst, machineChartInst;

// â”€â”€â”€ FETCH LIVE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  if (GIST_URL === 'PASTE_GIST_RAW_URL_HERE') {
    DATA = FALLBACK;
    renderAll(false);
    return;
  }
  try {
    // GitHub Gist API returns: { files: { "crash_summary.json": { content: "..." } } }
    // Adding no-cache headers ensures we always get the latest revision
    const res = await fetch(GIST_URL + '?_t=' + Date.now(), {
      headers: { 'Accept': 'application/vnd.github+json' }
    });
    if (res.ok) {
      const gist = await res.json();
      const fileInfo = gist.files['crash_summary.json'];
      if (fileInfo) {
        let raw;
        if (fileInfo.truncated || !fileInfo.content) {
          // Large file - content is truncated, must fetch raw_url directly
          // raw_url contains commit hash so it's always current
          const rawRes = await fetch(fileInfo.raw_url);
          raw = await rawRes.text();
        } else {
          raw = fileInfo.content;
        }
        DATA = JSON.parse(raw);
        // If the Gist contains the full items array, compute all aggregations
        if (DATA.items && Array.isArray(DATA.items)) {
          const processed = processItems(DATA);
          if (processed) DATA = processed;
        }
        renderAll(true);
      } else {
        DATA = FALLBACK; renderAll(false);
      }
    } else {
      DATA = FALLBACK; renderAll(false);
    }
  } catch(e) {
    DATA = FALLBACK;
    renderAll(false);
  }
}

// â”€â”€â”€ RENDER ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(isLive) {
  // Header
  document.getElementById('headerTotal').textContent = DATA.total;
  document.getElementById('headerSub').textContent = `${DATA.uniqueMachines} devices Â· Dell OptiPlex Fleet Â· ${isLive ? 'Live data' : 'Cached data'}`;
  if (DATA.lastUpdated) {
    const d = new Date(DATA.lastUpdated);
    document.getElementById('lastUpdated').textContent = 'Updated: ' + d.toLocaleString();
  }

  // Build AI context string
  aiContext = `Live crash data summary: ${DATA.total} total events across ${DATA.uniqueMachines} machines. ` +
    `Event breakdown: Event 41=${DATA.eventIds['41']||0}, Event 6008=${DATA.eventIds['6008']||0}, Event 1001=${DATA.eventIds['1001']||0}. ` +
    `Top crasher: ${DATA.topCrasher?.host} with ${DATA.topCrasher?.count} crashes. ` +
    `Outdated BIOS (${DATA.outdatedBiosPct}%): ${(DATA.biosOutdatedMachines||[]).join(', ')}. ` +
    `Machines needing SFC scan: ${(DATA.startupRepairMachines||[]).join(', ')}.`;

  renderOverview(isLive);
  renderMachines();
  renderFindings();
}

// â”€â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOverview(isLive) {
  document.getElementById('overviewLoading').style.display = 'none';
  document.getElementById('overviewContent').style.display = 'block';

  const avgCrashes = DATA.uniqueMachines ? (DATA.total / DATA.uniqueMachines).toFixed(1) : 0;
  const statRow = document.getElementById('statRow');
  statRow.innerHTML = [
    ['var(--red)', DATA.total, 'Total Crash Events', 'All event types combined'],
    ['var(--orange)', DATA.uniqueMachines, 'Affected Machines', 'All Dell OptiPlex'],
    ['var(--yellow)', DATA.eventIds['41']||0, 'Kernel Crashes', 'Event ID 41 incidents'],
    ['var(--purple)', (DATA.outdatedBiosPct||0)+'%', 'Outdated BIOS', 'Still on v1.30.0'],
    ['var(--red)', (DATA.startupRepairMachines||[]).length, 'Need SFC Scan', 'Triggered Startup Repair'],
    ['var(--cyan)', avgCrashes, 'Avg Crashes', 'Per machine / 30 days']
  ].map(([color, val, label, sub]) => `
    <div class="stat-card">
      <div class="stat-val" style="color:${color}">${val}</div>
      <div class="stat-label">${label}</div>
      <div class="stat-sub">${sub}</div>
    </div>`).join('');

  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

  // Donut
  const evLabels = Object.keys(DATA.eventIds);
  const evVals = Object.values(DATA.eventIds);
  const evColors = ['#ef4444','#f97316','#3b82f6','#a855f7','#22c55e'];
  if(donutChartInst) donutChartInst.destroy();
  donutChartInst = new Chart(document.getElementById('donutChart'),{
    type:'doughnut',
    data:{labels:evLabels.map(k=>'Event '+k),datasets:[{data:evVals,backgroundColor:evColors,borderWidth:3,borderColor:'#0f172a',hoverOffset:6}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},cutout:'62%'}
  });
  document.getElementById('donutLegend').innerHTML = evLabels.map((k,i)=>`
    <div class="legend-item">
      <div class="legend-dot" style="background:${evColors[i]}"></div>
      <div class="legend-label">Event ${k}</div>
      <div class="legend-val" style="color:${evColors[i]}">${evVals[i]}</div>
    </div>`).join('');

  // Timeline
  const tlLabels = Object.keys(DATA.timeline||{});
  const tlVals = Object.values(DATA.timeline||{});
  if(timelineChartInst) timelineChartInst.destroy();
  timelineChartInst = new Chart(document.getElementById('timelineChart'),{
    type:'line',
    data:{labels:tlLabels,datasets:[{label:'Crashes',data:tlVals,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true,tension:0.3,pointBackgroundColor:'#ef4444',pointRadius:3,borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:45,font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });

  // BIOS
  const biosLabels = Object.keys(DATA.biosVersions||{});
  const biosVals = Object.values(DATA.biosVersions||{});
  const biosColors = biosLabels.map(k=>k==='1.30.0'?'#f97316':k==='1.33.0'?'#22c55e':'#06b6d4');
  if(biosChartInst) biosChartInst.destroy();
  biosChartInst = new Chart(document.getElementById('biosChart'),{
    type:'bar',
    data:{labels:biosLabels,datasets:[{data:biosVals,backgroundColor:biosColors,borderRadius:5,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });
  document.getElementById('biosAlert').textContent = `âš ï¸ ${DATA.outdatedBiosCount||0} crash events from machines on outdated BIOS â€” update recommended`;

  // OS
  const osLabels = Object.keys(DATA.osBuilds||{}).map(k=>'Build '+k);
  const osVals = Object.values(DATA.osBuilds||{});
  if(osChartInst) osChartInst.destroy();
  osChartInst = new Chart(document.getElementById('osChart'),{
    type:'bar',
    data:{labels:osLabels,datasets:[{data:osVals,backgroundColor:['#a855f7','#6366f1'],borderRadius:5,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });
}

// â”€â”€â”€ MACHINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMachines() {
  const machines = Object.entries(DATA.crashesPerMachine||{}).sort((a,b)=>b[1]-a[1]);
  const colors = machines.map(([,c])=>c>=10?'#ef4444':c>=6?'#f97316':c>=4?'#eab308':'#3b82f6');
  if(machineChartInst) machineChartInst.destroy();
  machineChartInst = new Chart(document.getElementById('machineChart'),{
    type:'bar',
    data:{labels:machines.map(([h])=>h.replace('DSD-','')),datasets:[{data:machines.map(([,c])=>c),backgroundColor:colors,borderRadius:[4,4,0,0],borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });

  const tbody = document.getElementById('machineTableBody');
  tbody.innerHTML = machines.map(([host, count])=>{
    const bios = (DATA.biosOutdatedMachines||[]).includes(host)?'1.30.0 âš ï¸':'current';
    const biosColor = bios.includes('1.30')?'#f97316':'#64748b';
    const needsRepair = (DATA.startupRepairMachines||[]).includes(host);
    const risk = count>=10?['CRITICAL','#ef4444']:count>=6?['HIGH','#f97316']:count>=4?['MEDIUM','#eab308']:['LOW','#3b82f6'];
    const actions = [];
    if(bios.includes('1.30')) actions.push('<span style="color:#f97316">Update BIOS</span>');
    if(needsRepair) actions.push('<span style="color:#ef4444">Run sfc /scannow</span>');
    if(!actions.length) actions.push('<span style="color:#22c55e">âœ“ Monitor</span>');
    return `<tr>
      <td class="mono">${host}</td>
      <td class="mono" style="font-weight:700;color:${risk[1]}">${count}</td>
      <td><span class="badge" style="color:${risk[1]};background:${risk[1]}22">${risk[0]}</span></td>
      <td class="mono" style="color:${biosColor}">${bios}</td>
      <td class="mono" style="color:#64748b">â€”</td>
      <td>${actions.join(' &nbsp;')}</td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€ FINDINGS (dynamically generated from live data) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFindings() {
  const findings = generateFindings();
  document.getElementById('findingsHeader').textContent =
    `ğŸ” Analysis based on ${DATA.total} real crash events from ${DATA.uniqueMachines} Takeda DS machines. Click any finding to expand remediation steps.`;

  const container = document.getElementById('findingsContainer');
  container.innerHTML = '';
  findings.forEach((f,i)=>{
    const div = document.createElement('div');
    div.className='finding';
    div.style.cssText=`background:${f.color}11;border:1px solid ${f.color}33`;
    div.innerHTML=`
      <div class="finding-header">
        <div class="finding-icon">${f.icon}</div>
        <div class="finding-body">
          <div>
            <span class="finding-severity" style="color:${f.color};background:${f.color}22">${f.sev}</span>
            <span class="finding-count">${f.count}</span>
          </div>
          <div class="finding-title">${f.title}</div>
          <div class="finding-detail">${f.detail}</div>
          <div class="steps" id="steps-${i}">
            <div class="steps-title">Recommended Steps</div>
            ${f.steps.map((s,j)=>`<div class="step">
              <div class="step-num" style="background:${f.color}33;color:${f.color}">${j+1}</div>
              <div class="step-text">${s}</div>
            </div>`).join('')}
          </div>
          <div class="finding-toggle" id="toggle-${i}">â–¼ Click to see fix steps</div>
        </div>
      </div>`;
    div.onclick=()=>{
      const steps=document.getElementById('steps-'+i);
      const toggle=document.getElementById('toggle-'+i);
      const open=steps.classList.toggle('open');
      toggle.textContent=open?'â–² Click to collapse':'â–¼ Click to see fix steps';
    };
    container.appendChild(div);
  });
}

function generateFindings() {
  const findings = [];
  const total = DATA.total || 0;
  const ev41 = DATA.eventIds?.['41'] || 0;
  const ev6008 = DATA.eventIds?.['6008'] || 0;
  const ev1001 = DATA.eventIds?.['1001'] || 0;
  const repairMachines = DATA.startupRepairMachines || [];
  const outdatedMachines = DATA.biosOutdatedMachines || [];
  const topCrasher = DATA.topCrasher || {};
  const outdatedPct = DATA.outdatedBiosPct || 0;
  const outdatedCount = DATA.outdatedBiosCount || 0;

  // Finding 1 â€” Power Loss (always present if Event 41/6008 exist)
  if(ev41 > 0 || ev6008 > 0) {
    findings.push({
      sev:'CRITICAL', color:'#ef4444', icon:'âš¡',
      title:'Widespread Unexpected Power Loss / Kernel Panics',
      count:`${ev41+ev6008} events (Event 41 + 6008)`,
      detail:`${Math.round(((ev41+ev6008)/total)*100)}% of all crashes are Kernel-Power Event 41 paired with Event 6008 â€” every machine is losing power without a clean shutdown. The OS never gets a chance to write a shutdown reason. This is hardware-level power interruption, NOT software or app crashes.`,
      steps:[
        'Check power strips and UPS devices at each display location â€” shared circuits may be browning out overnight',
        'Enable Fast Startup: Control Panel â†’ Power Options â†’ Choose what power buttons do â†’ Turn on fast startup',
        "Set BIOS 'AC Recovery' to 'Power On' so machines auto-restart after power outages",
        'Review if AV/display equipment on the same circuit causes surges when powering on'
      ]
    });
  }

  // Finding 2 â€” Outdated BIOS
  if(outdatedMachines.length > 0) {
    findings.push({
      sev:'HIGH', color:'#f97316', icon:'ğŸ”§',
      title:`Outdated BIOS on ${outdatedPct}% of Fleet`,
      count:`${outdatedCount} crash events on BIOS 1.30.0 machines`,
      detail:`Machines on BIOS 1.30.0 account for ${outdatedPct}% of all events. Current version is 1.33.0 (released Dec 2025). Dell BIOS updates frequently include power management and stability fixes â€” upgrading may directly reduce crash frequency.`,
      steps:[
        'Download BIOS 1.33.0 from dell.com/support â€” search OptiPlex Micro 7010',
        `Deploy via GoTo Resolve to: ${outdatedMachines.join(', ')}`,
        'Run silently: dell-bios-update.exe /silent /reboot',
        'Verify after update: (Get-WmiObject -Class Win32_BIOS).SMBIOSBIOSVersion'
      ]
    });
  }

  // Finding 3 â€” Startup Repair
  if(repairMachines.length > 0) {
    findings.push({
      sev:'HIGH', color:'#f97316', icon:'ğŸ”',
      title:`${repairMachines.length} Machines Required Windows Startup Repair`,
      count:`${ev1001} Event ID 1001 occurrences`,
      detail:`${repairMachines.join(', ')} triggered Windows Startup Repair after crashes. Abrupt shutdowns corrupted the file system enough that Windows couldn't boot normally. These machines are at highest risk of full OS failure.`,
      steps:[
        `Run via GoTo Resolve on all ${repairMachines.length} machines: sfc /scannow`,
        'Then run: DISM /Online /Cleanup-Image /RestoreHealth',
        `Consider reimaging ${topCrasher.host} â€” it has ${topCrasher.count} total crashes`,
        'Enable BitLocker recovery key escrow in case a drive fails mid-crash'
      ]
    });
  }

  // Finding 4 â€” Top crasher
  if(topCrasher.host && topCrasher.count >= 8) {
    findings.push({
      sev:'MEDIUM', color:'#eab308', icon:'ğŸ“ˆ',
      title:`${topCrasher.host} is a Repeat Offender`,
      count:`${topCrasher.count} crashes â€” highest in fleet`,
      detail:`${topCrasher.host} has crashed ${topCrasher.count} times â€” roughly every ${(30/topCrasher.count).toFixed(1)} days. ${outdatedMachines.includes(topCrasher.host)?'It also has outdated BIOS 1.30.0 and ':''} needs hands-on attention before it fails completely.`,
      steps:[
        `Physically inspect the power connection and outlet at ${topCrasher.host}'s location`,
        'Update BIOS to 1.33.0 as the first remediation step',
        'Check recent Event Log: Get-WinEvent -LogName System -MaxEvents 50',
        'If crashes continue after BIOS update, replace the machine proactively'
      ]
    });
  }

  // Finding 5 â€” Cluster detection (if any timeline date has 8+ crashes)
  const clusterDate = Object.entries(DATA.timeline||{}).find(([,v])=>v>=8);
  if(clusterDate) {
    findings.push({
      sev:'LOW', color:'#3b82f6', icon:'ğŸ“…',
      title:`Crash Cluster Detected on ${clusterDate[0]}`,
      count:`${clusterDate[1]} crashes on a single day`,
      detail:`${clusterDate[1]} machines all crashed on ${clusterDate[0]} in a short window. This is a strong indicator of a facility-level power event â€” a brief outage, sag, or circuit overload at the Takeda site.`,
      steps:[
        `Contact Takeda facilities team â€” ask about any power event on ${clusterDate[0]}`,
        'Review UPS logs for that time window if available',
        'Ensure all DS players are on battery-backed UPS, not raw wall outlets',
        'Add surge protectors rated for signage equipment (minimum 2700 joules)'
      ]
    });
  }

  return findings;
}

// â”€â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id, btn) {
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  btn.classList.add('active');
}

// â”€â”€â”€ AI ASSIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setQ(q){ document.getElementById('aiInput').value=q; }

async function askAI() {
  const query = document.getElementById('aiInput').value.trim();
  if(!query) return;
  const btn = document.getElementById('aiBtn');
  const box = document.getElementById('aiResponseBox');
  const text = document.getElementById('aiResponseText');
  btn.disabled=true;
  btn.innerHTML='<span class="spinner"></span>Thinking...';
  box.style.display='block';
  text.textContent='';
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system:`You are an expert Windows IT engineer analyzing crash telemetry for Takeda digital signage PCs.
${aiContext}
All crashes are Kernel-Power Event 41 + Event 6008 (unexpected power loss) â€” hardware-level power interruption.
Remote management via GoTo Resolve. Give concise, actionable technical advice with specific commands.`,
        messages:[{role:'user',content:query}]
      })
    });
    const data=await res.json();
    text.textContent=data.content?.[0]?.text||'No response received.';
  } catch(e) {
    text.textContent='Error connecting to AI. Please try again.';
  }
  btn.disabled=false;
  btn.textContent='Ask';
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();
// Refresh every 30 minutes
setInterval(loadData, 30*60*1000);
</script>
</body>
</html>
