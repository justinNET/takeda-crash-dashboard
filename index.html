<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Takeda DS Player Crash Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0a0f1e;--surface:rgba(255,255,255,0.03);--border:rgba(255,255,255,0.07);
    --text:#e2e8f0;--muted:#94a3b8;--dim:#64748b;
    --red:#ef4444;--orange:#f97316;--yellow:#eab308;--green:#22c55e;--blue:#3b82f6;--purple:#a855f7;--cyan:#06b6d4;
    --indigo:#4f46e5;
  }
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',system-ui,sans-serif;min-height:100vh;overflow-x:hidden}
  .wrapper{max-width:1400px;margin:0 auto;overflow-x:hidden}
  .header{background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 100%);border-bottom:1px solid rgba(99,102,241,0.2);padding:24px 32px}
  .header-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
  .live-dot{width:9px;height:9px;border-radius:50%;background:var(--red);box-shadow:0 0 10px var(--red);animation:pulse 2s infinite;display:inline-block;margin-right:8px}
  .live-label{font-size:11px;font-family:'DM Mono',monospace;color:var(--red);letter-spacing:2px;text-transform:uppercase}
  h1{font-size:26px;font-weight:800;letter-spacing:-0.5px;margin-top:6px}
  .header-sub{font-size:12px;color:var(--dim);margin-top:3px}
  .header-count{text-align:right}
  .big-num{font-size:48px;font-weight:900;color:var(--red);font-family:'DM Mono',monospace;line-height:1}
  .big-label{font-size:12px;color:var(--dim)}
  .last-updated{font-size:11px;color:var(--dim);margin-top:4px;font-family:'DM Mono',monospace}
  .tabs-wrap{max-width:1100px;margin:0 auto;padding:28px 32px 0}
  .tabs{display:flex;gap:4px;background:rgba(255,255,255,0.03);border-radius:10px;padding:4px;width:fit-content;margin-bottom:28px}
  .tab{padding:8px 20px;border-radius:7px;border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all 0.2s;background:transparent;color:var(--dim)}
  .tab.active{background:rgba(99,102,241,0.25);color:#a5b4fc}
  .content{display:none;max-width:1100px;margin:0 auto;padding:0 32px 60px}
  .content.active{display:block}
  .stat-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:28px}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 22px;flex:1;min-width:130px}
  .alert-host{background:#1e293b;color:#e2e8f0;padding:2px 8px;border-radius:4px;font-size:11px;font-family:monospace;display:inline-flex;align-items:center;gap:5px;margin:2px}
  .stat-val{font-size:34px;font-weight:800;font-family:'DM Mono',monospace;letter-spacing:-1px}
  .stat-label{font-size:12px;color:var(--muted);margin-top:3px;font-weight:500}
  .stat-sub{font-size:11px;color:var(--dim);margin-top:2px}
  .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-bottom:22px}
  .chart-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px}
  .chart-title{font-size:12px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:18px}
  .legend{display:flex;flex-direction:column;gap:7px;margin-top:14px}
  .legend-item{display:flex;align-items:center;gap:9px}
  .legend-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
  .legend-label{font-size:12px;color:var(--muted);flex:1}
  .legend-val{font-size:13px;font-weight:700;font-family:'DM Mono',monospace}
  .alert{padding:10px 14px;border-radius:8px;font-size:12px;margin-top:12px}
  .alert-orange{background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);color:#fdba74}
  .alert-indigo{background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);color:#a5b4fc}
  .alert-green{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);color:#86efac}
  .table-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-top:0}
  .table-card-scroll{overflow-x:auto;width:100%}
  table{width:100%;border-collapse:collapse;min-width:700px}
  thead tr{background:rgba(255,255,255,0.05)}
  th{padding:11px 15px;text-align:left;font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:700}
  td{padding:11px 15px;font-size:13px;border-top:1px solid rgba(255,255,255,0.04)}
  tr:nth-child(even){background:rgba(255,255,255,0.01)}
  .mono{font-family:'DM Mono',monospace}
  .badge{font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px}
  .finding{border-radius:13px;padding:22px;margin-bottom:14px;cursor:pointer;transition:all 0.2s}
  .finding:hover{filter:brightness(1.05)}
  .finding-header{display:flex;align-items:flex-start;gap:14px}
  .finding-icon{font-size:26px;flex-shrink:0}
  .finding-body{flex:1}
  .finding-severity{font-size:11px;font-weight:800;padding:3px 10px;border-radius:4px;letter-spacing:1px;display:inline-block;margin-bottom:8px}
  .finding-count{font-size:12px;color:var(--dim);font-family:'DM Mono',monospace;margin-left:10px}
  .finding-title{font-size:16px;font-weight:700;color:#f1f5f9;margin-bottom:7px}
  .finding-detail{font-size:13px;color:var(--muted);line-height:1.65}
  .finding-toggle{font-size:12px;color:var(--dim);margin-top:10px}
  .steps{margin-top:14px;padding:15px 18px;background:rgba(0,0,0,0.3);border-radius:9px;border:1px solid rgba(255,255,255,0.05);display:none}
  .steps.open{display:block}
  .steps-title{font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
  .step{display:flex;gap:10px;margin-bottom:9px;align-items:flex-start}
  .step-num{width:22px;height:22px;border-radius:50%;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
  .step-text{font-size:13px;color:#cbd5e1;line-height:1.6}
  .ai-box{background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:13px;padding:22px;margin-bottom:22px}
  .ai-title{font-size:16px;font-weight:700;color:#a5b4fc;margin-bottom:6px}
  .ai-sub{font-size:13px;color:var(--dim);margin-bottom:16px}
  .ai-input-row{display:flex;gap:10px}
  .ai-input{flex:1;padding:11px 15px;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text);font-size:13px;font-family:'DM Sans',sans-serif;outline:none}
  .ai-input:focus{border-color:rgba(99,102,241,0.5)}
  .ai-btn{padding:11px 22px;background:var(--indigo);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;font-family:'DM Sans',sans-serif}
  .ai-btn:disabled{background:#334155;cursor:not-allowed}
  .quick-prompts{display:flex;gap:7px;margin-top:11px;flex-wrap:wrap}
  .qp{padding:6px 11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.09);border-radius:6px;color:var(--muted);font-size:11px;cursor:pointer;font-family:'DM Sans',sans-serif}
  .qp:hover{background:rgba(255,255,255,0.09);color:var(--text)}
  .ai-response{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:22px}
  .ai-response-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:12px}
  .ai-response-text{font-size:14px;color:#cbd5e1;line-height:1.8;white-space:pre-wrap}
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;margin-right:6px;vertical-align:middle}
  .loading-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;gap:16px}
  .loading-spinner{width:40px;height:40px;border:3px solid rgba(99,102,241,0.2);border-top-color:#4f46e5;border-radius:50%;animation:spin 1s linear infinite}
  .loading-text{font-size:14px;color:var(--dim)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <div></div>
      <h1>Takeda DS Player Crash Intelligence</h1>
      <div class="header-sub" id="headerSub">Loading data...</div>
    </div>
    <div class="header-count">
      <div class="big-num" id="headerTotal">‚Äî</div>
      <div class="big-label">total crash events</div>
      <div class="last-updated" id="lastUpdated"></div>
    </div>
  </div>
</div>

<div class="tabs-wrap">
  <div class="tabs">
    <button class="tab active" onclick="switchTab('overview',this)">Overview</button>
    <button class="tab" onclick="switchTab('machines',this)">Machines</button>
    <button class="tab" onclick="switchTab('fixes',this)">Findings &amp; Fixes</button>
    <button class="tab" onclick="switchTab('ai',this)">ü§ñ AI Assist</button>
  </div>
</div>

<div id="tab-overview" class="content active">
  <div id="overviewLoading" class="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Fetching live crash data from SharePoint...</div>
  </div>
  <div id="overviewContent" style="display:none">
    <div class="stat-row" id="statRow"></div>
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-title">Event Type Breakdown</div>
        <div style="height:180px"><canvas id="donutChart"></canvas></div>
        <div class="legend" id="donutLegend"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Crash Timeline</div>
        <div style="height:220px"><canvas id="timelineChart"></canvas></div>
      </div>
    </div>
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-title">BIOS Version Distribution</div>
        <div style="height:140px"><canvas id="biosChart"></canvas></div>
        <div class="alert alert-orange" id="biosAlert"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">OS Build Distribution</div>
        <div style="height:140px"><canvas id="osChart"></canvas></div>
        <div class="alert alert-indigo">‚ÑπÔ∏è Both OS builds equally affected ‚Äî not an OS version issue</div>
      </div>
    </div>
    <!-- Fleet Health Alert Cards -->
    <div id="fleetAlerts" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-top:8px"></div>
  </div>
</div>

<div id="tab-machines" class="content">
  <div class="chart-card" style="margin-bottom:22px">
    <div class="chart-title">Crashes Per Machine</div>
    <div style="height:300px"><canvas id="machineChart"></canvas></div>
  </div>

  <!-- Search + Export row -->
  <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
    <input id="machineSearch" type="text" placeholder="üîç Search hostname..." oninput="filterMachines()"
      style="flex:1;min-width:180px;background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:8px 14px;border-radius:8px;font-size:13px;outline:none">
    <button onclick="exportCSV()" style="background:#1e293b;color:#22c55e;border:1px solid #22c55e44;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;white-space:nowrap">‚¨á Export CSV</button>
    <button onclick="downloadAllScripts()" style="background:#14532d;color:#22c55e;border:1px solid #22c55e55;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;white-space:nowrap">‚¨á All Fix Scripts (.ps1)</button>
  </div>
  <div style="background:#0a1628;border:1px solid #1e3a5f;border-radius:10px;padding:16px 20px;margin-bottom:14px">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <span style="background:#1e3a5f;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;color:#60a5fa;letter-spacing:0.5px">üïí SCHEDULED REMEDIATION</span>
      <span style="color:#22c55e;font-size:12px;font-weight:600">Scripts run ONCE at 3:00 AM local PC time ‚Äî nothing executes during the day</span>
    </div>
    <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 14px;font-size:12px;align-items:start">
      <span style="color:#3b82f6;font-weight:700;white-space:nowrap">Step 1 ¬∑ File Distribution</span>
      <span style="color:#94a3b8">Upload the .ps1 ‚Üí destination: <code style="background:#1e293b;padding:1px 6px;border-radius:3px;color:#22c55e">C:\Scripts</code> ‚Üí enable <strong style="color:#e2e8f0">Overwrite existing files</strong></span>
      <span style="color:#3b82f6;font-weight:700;white-space:nowrap">Step 2 ¬∑ Wait</span>
      <span style="color:#94a3b8">120 seconds</span>
      <span style="color:#3b82f6;font-weight:700;white-space:nowrap">Step 3 ¬∑ PowerShell</span>
      <span style="color:#94a3b8">Paste the command below ‚Äî <em>only registers the 3AM task, nothing runs now</em></span>
    </div>
    <pre style="background:#060d1a;border:1px solid #1e3a5f;border-radius:6px;padding:10px 14px;margin:12px 0 8px;font-size:11px;color:#22c55e;overflow-x:auto;white-space:pre-wrap;line-height:1.6">$h = $env:COMPUTERNAME
$f = "C:\Scripts\TakedaRemediation_ALL_MACHINES.ps1"
$now = Get-Date
$run = $now.Date.AddHours(3); if($now.Hour -ge 3){$run = $run.AddDays(1)}
$a = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-NonInteractive -ExecutionPolicy Bypass -File `"$f`""
$t = New-ScheduledTaskTrigger -Once -At $run
$s = New-ScheduledTaskSettingsSet -ExecutionTimeLimit (New-TimeSpan -Hours 2) -StartWhenAvailable
Register-ScheduledTask -TaskName "TakedaRemediation_$h" -Action $a -Trigger $t -Settings $s -RunLevel Highest -Force | Out-Null
Write-Host "‚úÖ Scheduled ONCE for $run ‚Äî runs at 3:00 AM tonight then never again"</pre>
    <div style="display:flex;gap:16px;font-size:11px;color:#475569">
      <span>üìÅ Logs ‚Üí <code style="color:#64748b">C:\Logs\</code> on each machine</span>
      <span>üîÑ After 3AM ‚Üí delete old SharePoint records so dashboard refreshes</span>
      <span>‚ö†Ô∏è BIOS updates ‚Üí manual deployment required</span>
    </div>
  </div>

  <!-- Bulk action bar (hidden until items checked) -->
  <div id="bulkBar" style="display:none;align-items:center;gap:10px;background:#0a1628;border:1px solid #1e3a5f;border-radius:8px;padding:10px 16px;margin-bottom:12px;flex-wrap:wrap">
    <span id="bulkCount" style="color:#60a5fa;font-size:13px;font-weight:600"></span>
    <button onclick="exportCSV()" style="background:#14532d;color:#22c55e;border:1px solid #22c55e44;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px">‚¨á Export Selected CSV</button>
    <button onclick="viewSelectedInSP()" style="background:#1e3a5f;color:#60a5fa;border:1px solid #3b82f633;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px">üìã View in SharePoint</button>
    <a href="https://proneweratech.sharepoint.com/sites/JustinsSharepointSite/Lists/DeviceCrashEvents/AllItems.aspx" target="_blank" style="display:flex;align-items:center;gap:6px;background:#1e293b;border:1px solid #ef444466;border-radius:6px;padding:6px 14px;text-decoration:none">
      <span style="font-size:14px">üóëÔ∏è</span>
      <span style="color:#ef4444;font-size:12px;font-weight:700">Delete Records in SharePoint ‚Üó</span>
      <span style="color:#64748b;font-size:11px">‚Äî select rows ‚Üí Delete Item</span>
    </a>
    <button onclick="selectedMachines.clear();document.querySelectorAll('.machine-cb').forEach(b=>b.checked=false);document.getElementById('selectAll').checked=false;updateBulkBar()" style="background:transparent;color:#64748b;border:none;cursor:pointer;font-size:18px;margin-left:auto">√ó</button>
  </div>

  <div class="table-card"><div class="table-card-scroll">
    <table>
      <thead><tr>
        <th style="width:32px"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" style="accent-color:#3b82f6;cursor:pointer"></th>
        <th class="sort-th" data-col="host" data-label="Hostname" onclick="sortMachines('host')" style="cursor:pointer">Hostname ‚Üï</th>
        <th class="sort-th" data-col="crashes" data-label="Crashes" onclick="sortMachines('crashes')" style="cursor:pointer">Crashes ‚Üì</th>
        <th>Risk</th>
        <th class="sort-th" data-col="bios" data-label="BIOS" onclick="sortMachines('bios')" style="cursor:pointer">BIOS ‚Üï</th>
        <th class="sort-th" data-col="os" data-label="OS Build" onclick="sortMachines('os')" style="cursor:pointer">OS Build ‚Üï</th>
        <th class="sort-th" data-col="last" data-label="Last Crash" onclick="sortMachines('last')" style="cursor:pointer">Last Crash ‚Üï</th>
        <th>Action Needed <span style="color:#475569;font-weight:normal;font-size:10px">(click row for details)</span></th>
      </tr></thead>
      <tbody id="machineTableBody"></tbody>
    </table>
  </div></div>
</div>

<div id="tab-fixes" class="content">
  <div class="alert alert-indigo" style="margin-bottom:20px" id="findingsHeader"></div>
  <div id="findingsContainer"></div>
</div>

<div id="tab-ai" class="content">
  <div class="ai-box">
    <div class="ai-title">ü§ñ Ask AI About Your Crash Data</div>
    <div class="ai-sub">Claude has full context of your live crash data. Ask anything about remediation, patterns, or next steps.</div>
    <div style="margin-bottom:12px;padding:12px 14px;background:#0a1628;border:1px solid #1e3a5f;border-radius:8px">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span style="color:#94a3b8;font-size:12px;white-space:nowrap">üîë API Key:</span>
          <input id="apiKeyInput" type="password" placeholder="sk-ant-api03-..." 
            style="flex:1;min-width:220px;background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:7px 12px;border-radius:6px;font-size:12px;font-family:monospace;outline:none">
          <button onclick="saveKey()" style="background:#1e3a5f;color:#60a5fa;border:1px solid #3b82f633;padding:7px 14px;border-radius:6px;font-size:12px;cursor:pointer;white-space:nowrap">‚úì Save</button>
          <span id="keyStatus" style="font-size:11px;color:#64748b"></span>
        </div>
        <div style="margin-top:6px;font-size:10px;color:#475569">Get a free key at <a href="https://console.anthropic.com" target="_blank" style="color:#60a5fa">console.anthropic.com</a> ‚Üí API Keys. Set a $5 monthly limit. Key lives in browser memory only ‚Äî never stored or sent anywhere except Anthropic.</div>
      </div>
    <div class="ai-input-row">
      <input id="aiInput" class="ai-input" type="text" placeholder="e.g. Which machines should I prioritize? Write a GoTo Resolve BIOS update script..." onkeydown="if(event.key==='Enter')askAI()">
      <button class="ai-btn" id="aiBtn" onclick="askAI()">Ask</button>
    </div>
    <div class="quick-prompts">
      <button class="qp" onclick="setQ('Which machines are at highest risk of full OS failure?')">Which machines are highest risk?</button>
      <button class="qp" onclick="setQ('Write a PowerShell script to run sfc /scannow on machines that triggered Startup Repair')">Write SFC repair script</button>
      <button class="qp" onclick="setQ('What caused the crash cluster and how do I prevent it?')">Explain crash cluster</button>
      <button class="qp" onclick="setQ('What BIOS settings should I change for better crash recovery?')">BIOS settings to change</button>
    </div>
  </div>
  <div id="aiResponseBox" style="display:none" class="ai-response">
    <div class="ai-response-label">AI Response</div>
    <div id="aiResponseText" class="ai-response-text"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ GIST API URL - Uses GitHub API to bypass CDN caching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Raw URL caches aggressively and ignores cache busters. API always returns latest.
const GIST_ID = 'ad4d325dd588c805fb43c754afcac062';
const GIST_URL = `https://api.github.com/gists/${GIST_ID}`;

// ‚îÄ‚îÄ‚îÄ FALLBACK DATA (used until Gist is set up) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FALLBACK = {
  total: 73, uniqueMachines: 12, lastUpdated: "2026-02-26T17:00:00Z",
  eventIds: {"41":34,"6008":34,"1001":5},
  crashesPerMachine: {"DSD-29ZFWV3":12,"DSD-J9ZFWV3":11,"DSD-F9ZFWV3":9,"DSD-D9ZFWV3":8,"DSD-2BZFWV3":6,"DSD-GQV9B24":6,"DSD-FRV9B24":5,"DSD-C9ZFWV3":4,"DSD-FSV9B24":4,"DSD-G9ZFWV3":4,"DSD-1BZFWV3":2,"DSD-HS225K3":2},
  biosVersions: {"1.30.0":27,"1.33.0":44,"2.27.0":2},
  osBuilds: {"26100":33,"26200":40},
  outdatedBiosCount: 27, outdatedBiosPct: 37,
  startupRepairMachines: ["DSD-29ZFWV3","DSD-J9ZFWV3","DSD-F9ZFWV3","DSD-FRV9B24"],
  topCrasher: {host:"DSD-29ZFWV3", count:12},
  biosOutdatedMachines: ["DSD-29ZFWV3","DSD-F9ZFWV3","DSD-2BZFWV3"],
  timeline: {"Jan 29":12,"Feb 2":8,"Feb 5":4,"Feb 6":6,"Feb 9":3,"Feb 10":2,"Feb 14":8,"Feb 16":4,"Feb 17":10,"Feb 18":6,"Feb 19":4,"Feb 20":8,"Feb 23":3,"Feb 24":5,"Feb 26":6}
};

// ‚îÄ‚îÄ‚îÄ PROCESS RAW ITEMS FROM SHAREPOINT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// When the Gist contains a full items array, compute all aggregations here
function processItems(raw) {
  const items = raw.items || [];
  if (!items.length) return null;

  const total = items.length;

  // Unique machines by Hostname + track latest metadata per machine
  const machineMap = {};
  const machineDetails = {}; // hostname ‚Üí full metadata
  items.forEach(r => {
    const h = r.Hostname || r.Title || 'Unknown';
    machineMap[h] = (machineMap[h] || 0) + 1;
    // Keep latest record's metadata per machine
    const existing = machineDetails[h];
    const ts = new Date(r.CrashMarkerTime || r.Modified || 0);
    if (!existing || ts > new Date(existing.lastSeen || 0)) {
      machineDetails[h] = {
        bios: r.BIOSVersion || '',
        biosReleaseDate: r.BIOSReleaseDate || '',
        osBuild: r.OSBuild || '',
        osVersionFull: r.OSVersionFull || '',
        manufacturer: r.Manufacturer || '',
        model: r.Model || '',
        serialNumber: r.SerialNumber || '',
        cpuName: r.CPUName || '',
        totalRAM: r.TotalRAM_GB || '',
        diskFree: r.DiskFreeSpace_GB || '',
        displayDriver: r.DisplayDriverVersion || '',
        lastUpdateKB: r.LastUpdateKB || '',
        winUpdatePending: r.WindowsUpdatePending || '',
        lastRebootReason: r.LastRebootReason || '',
        scalaArtifacts: r.ScalaArtifacts || '',
        ipAddress: r.IPAddress || '',
        macAddress: r.MACAddress || '',
        uptime: r.UptimeAtReport || '',
        appspaceVersion: r.AppspaceVersion || '',
        scriptVersion: r.ScriptVersion || '',
        lastSeen: r.CrashMarkerTime || r.Modified || ''
      };
    }
  });
  const uniqueMachines = Object.keys(machineMap).length;

  // Event ID breakdown from CrashMarkerEventID
  const eventIds = {};
  items.forEach(r => {
    const ev = r.CrashMarkerEventID || 'Unknown';
    eventIds[ev] = (eventIds[ev] || 0) + 1;
  });

  // BIOS versions
  const biosVersions = {};
  items.forEach(r => {
    const b = r.BIOSVersion || 'Unknown';
    biosVersions[b] = (biosVersions[b] || 0) + 1;
  });

  // OS builds
  const osBuilds = {};
  items.forEach(r => {
    const os = r.OSBuild || 'Unknown';
    osBuilds[os] = (osBuilds[os] || 0) + 1;
  });

  // Outdated BIOS = version 1.30.x
  const outdatedBiosMachines = [...new Set(
    items.filter(r => (r.BIOSVersion||'').startsWith('1.30')).map(r => r.Hostname || r.Title)
  )];
  const outdatedBiosCount = items.filter(r => (r.BIOSVersion||'').startsWith('1.30')).length;
  const outdatedBiosPct = Math.round((outdatedBiosMachines.length / uniqueMachines) * 100);

  // Startup repair machines = those with BugCheckCode or Event 1001
  const startupRepairMachines = [...new Set(
    items.filter(r => r.CrashMarkerEventID === '1001' || (r.BugCheckCode && r.BugCheckCode !== 'N/A' && r.BugCheckCode !== '')).map(r => r.Hostname || r.Title)
  )];

  // Timeline: group by date of CrashMarkerTime
  const timeline = {};
  items.forEach(r => {
    if (!r.CrashMarkerTime) return;
    const d = new Date(r.CrashMarkerTime);
    if (isNaN(d)) return;
    const label = (d.getMonth()+1) + '/' + d.getDate();
    timeline[label] = (timeline[label] || 0) + 1;
  });
  // Sort timeline by date
  const sortedTimeline = {};
  Object.keys(timeline).sort((a,b) => {
    const [am,ad] = a.split('/').map(Number);
    const [bm,bd] = b.split('/').map(Number);
    return am !== bm ? am - bm : ad - bd;
  }).forEach(k => sortedTimeline[k] = timeline[k]);

  // Top crasher
  const sortedMachines = Object.entries(machineMap).sort((a,b) => b[1]-a[1]);
  const topCrasher = sortedMachines[0] ? {host: sortedMachines[0][0], count: sortedMachines[0][1]} : {host:'N/A', count:0};

  return {
    total, uniqueMachines, lastUpdated: raw.lastUpdated,
    eventIds, crashesPerMachine: machineMap, machineDetails,
    biosVersions, osBuilds,
    outdatedBiosCount, outdatedBiosPct,
    outdatedBiosMachines, biosOutdatedMachines: outdatedBiosMachines,
    startupRepairMachines, topCrasher, timeline: sortedTimeline
  };
}

let DATA = FALLBACK;
let aiContext = '';
let donutChartInst, timelineChartInst, biosChartInst, osChartInst, machineChartInst;

// ‚îÄ‚îÄ‚îÄ FETCH LIVE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  if (GIST_URL === 'PASTE_GIST_RAW_URL_HERE') {
    DATA = FALLBACK;
    renderAll(false);
    return;
  }
  try {
    // GitHub Gist API returns: { files: { "crash_summary.json": { content: "..." } } }
    // Adding no-cache headers ensures we always get the latest revision
    const res = await fetch(GIST_URL + '?_t=' + Date.now(), {
      headers: { 'Accept': 'application/vnd.github+json' }
    });
    if (res.ok) {
      const gist = await res.json();
      const fileInfo = gist.files['crash_summary.json'];
      if (fileInfo) {
        let raw;
        if (fileInfo.truncated || !fileInfo.content) {
          // Large file - content is truncated, must fetch raw_url directly
          // raw_url contains commit hash so it's always current
          const rawRes = await fetch(fileInfo.raw_url);
          raw = await rawRes.text();
        } else {
          raw = fileInfo.content;
        }
        DATA = JSON.parse(raw);
        // If the Gist contains the full items array, compute all aggregations
        if (DATA.items && Array.isArray(DATA.items)) {
          const processed = processItems(DATA);
          if (processed) DATA = processed;
        }
        renderAll(true);
      } else {
        DATA = FALLBACK; renderAll(false);
      }
    } else {
      DATA = FALLBACK; renderAll(false);
    }
  } catch(e) {
    DATA = FALLBACK;
    renderAll(false);
  }
}

// ‚îÄ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll(isLive) {
  // Header
  document.getElementById('headerTotal').textContent = DATA.total;
  document.getElementById('headerSub').textContent = `${DATA.uniqueMachines} devices reporting`;
  if (DATA.lastUpdated) {
    const d = new Date(DATA.lastUpdated);
    document.getElementById('lastUpdated').textContent = 'Updated: ' + d.toLocaleString();
  }

  // Build AI context string
  aiContext = `Live crash data summary: ${DATA.total} total events across ${DATA.uniqueMachines} machines. ` +
    `Event breakdown: Event 41=${DATA.eventIds['41']||0}, Event 6008=${DATA.eventIds['6008']||0}, Event 1001=${DATA.eventIds['1001']||0}. ` +
    `Top crasher: ${DATA.topCrasher?.host} with ${DATA.topCrasher?.count} crashes. ` +
    `Outdated BIOS (${DATA.outdatedBiosPct}%): ${(DATA.biosOutdatedMachines||[]).join(', ')}. ` +
    `Machines needing SFC scan: ${(DATA.startupRepairMachines||[]).join(', ')}.`;

  renderOverview(isLive);
  renderMachines();
  renderFindings();
}

// ‚îÄ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverview(isLive) {
  document.getElementById('overviewLoading').style.display = 'none';
  document.getElementById('overviewContent').style.display = 'block';

  const avgCrashes = DATA.uniqueMachines ? (DATA.total / DATA.uniqueMachines).toFixed(1) : 0;
  const statRow = document.getElementById('statRow');
  statRow.innerHTML = [
    ['var(--red)', DATA.total, 'Total Crash Events', 'All event types combined'],
    ['var(--orange)', DATA.uniqueMachines, 'Affected Machines', 'Unique hostnames reporting'],
    ['var(--yellow)', DATA.eventIds['41']||0, 'Kernel Crashes', 'Event ID 41 incidents'],
    ['var(--purple)', (DATA.outdatedBiosPct||0)+'%', 'Outdated BIOS', 'Still on v1.30.0'],
    ['var(--red)', (DATA.startupRepairMachines||[]).length, 'Need SFC Scan', 'Triggered Startup Repair'],
    ['var(--cyan)', avgCrashes, 'Avg Crashes', 'Per machine / 30 days']
  ].map(([color, val, label, sub]) => `
    <div class="stat-card">
      <div class="stat-val" style="color:${color}">${val}</div>
      <div class="stat-label">${label}</div>
      <div class="stat-sub">${sub}</div>
    </div>`).join('');

  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

  // Donut ‚Äî with event descriptions
  const EVENT_DESCRIPTIONS = {
    '41':   {short:'Kernel-Power', desc:'System lost power without clean shutdown ‚Äî hardware power interruption'},
    '6008': {short:'Unexpected Shutdown', desc:'OS recorded that previous shutdown was unexpected ‚Äî pairs with Event 41'},
    '1001': {short:'Startup Repair', desc:'Windows triggered automatic repair after crash ‚Äî file system corruption risk'},
    '6':    {short:'Driver Failure', desc:'A driver triggered an unexpected shutdown or blue screen'},
    '41 ': {short:'Kernel-Power', desc:'Power loss event'},
  };
  const evKeys = Object.keys(DATA.eventIds);
  const evVals = Object.values(DATA.eventIds);
  const evColors = ['#ef4444','#f97316','#3b82f6','#a855f7','#22c55e','#06b6d4','#ec4899'];
  if(donutChartInst) donutChartInst.destroy();
  donutChartInst = new Chart(document.getElementById('donutChart'),{
    type:'doughnut',
    data:{
      labels: evKeys.map(k=> {
        const d = EVENT_DESCRIPTIONS[k];
        return d ? 'Event '+k+' ‚Äî '+d.short : 'Event '+k;
      }),
      datasets:[{data:evVals,backgroundColor:evColors,borderWidth:3,borderColor:'#0f172a',hoverOffset:10}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            title: (items) => items[0].label,
            label: (item) => {
              const k = evKeys[item.dataIndex];
              const desc = (EVENT_DESCRIPTIONS[k]||{}).desc || '';
              const pct = Math.round((item.raw / DATA.total)*100);
              return [' '+item.raw+' events ('+pct+'%)', desc ? ' '+desc : ''];
            }
          },
          backgroundColor:'#1e293b',
          titleColor:'#f1f5f9',
          bodyColor:'#94a3b8',
          borderColor:'#334155',
          borderWidth:1,
          padding:12,
          titleFont:{size:13},
          bodyFont:{size:11}
        }
      },
      cutout:'62%'
    }
  });
  document.getElementById('donutLegend').innerHTML = evKeys.map((k,i)=>{
    const d = EVENT_DESCRIPTIONS[k] || {};
    const pct = Math.round((evVals[i]/DATA.total)*100);
    return `<div class="legend-item" title="${d.desc||''}" style="cursor:default">
      <div class="legend-dot" style="background:${evColors[i]}"></div>
      <div style="flex:1">
        <div class="legend-label">Event ${k}${d.short?' <span style="color:#64748b;font-size:10px">‚Äî '+d.short+'</span>':''}</div>
        ${d.desc?`<div style="color:#475569;font-size:10px;margin-top:1px">${d.desc}</div>`:''}
      </div>
      <div class="legend-val" style="color:${evColors[i]}">${evVals[i]}</div>
    </div>`;
  }).join('');

  // Timeline
  const tlLabels = Object.keys(DATA.timeline||{});
  const tlVals = Object.values(DATA.timeline||{});
  if(timelineChartInst) timelineChartInst.destroy();
  timelineChartInst = new Chart(document.getElementById('timelineChart'),{
    type:'line',
    data:{labels:tlLabels,datasets:[{label:'Crashes',data:tlVals,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true,tension:0.3,pointBackgroundColor:'#ef4444',pointRadius:3,borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:45,font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });

  // BIOS
  const biosLabels = Object.keys(DATA.biosVersions||{});
  const biosVals = Object.values(DATA.biosVersions||{});
  const biosColors = biosLabels.map(k=>k==='1.30.0'?'#f97316':k==='1.33.0'?'#22c55e':'#06b6d4');
  if(biosChartInst) biosChartInst.destroy();
  biosChartInst = new Chart(document.getElementById('biosChart'),{
    type:'bar',
    data:{labels:biosLabels,datasets:[{data:biosVals,backgroundColor:biosColors,borderRadius:5,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });
  document.getElementById('biosAlert').textContent = `‚ö†Ô∏è ${DATA.outdatedBiosCount||0} crash events from machines on outdated BIOS ‚Äî update recommended`;

  // OS
  const osLabels = Object.keys(DATA.osBuilds||{}).map(k=>'Build '+k);
  const osVals = Object.values(DATA.osBuilds||{});
  if(osChartInst) osChartInst.destroy();
  osChartInst = new Chart(document.getElementById('osChart'),{
    type:'bar',
    data:{labels:osLabels,datasets:[{data:osVals,backgroundColor:['#a855f7','#6366f1'],borderRadius:5,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });

  // ‚îÄ‚îÄ Fleet Health Alert Cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const details = DATA.machineDetails || {};

  // Windows Updates pending
  const needsWinUpdate = Object.entries(details).filter(([,m])=>{
    const p = (m.winUpdatePending||'').toLowerCase();
    return p && p!=='none' && p!=='false' && p!=='0' && p!=='';
  });

  // Low disk space (<20GB)
  const lowDisk = Object.entries(details).filter(([,m])=>m.diskFree && parseFloat(m.diskFree)<20)
    .sort((a,b)=>parseFloat(a[1].diskFree)-parseFloat(b[1].diskFree));

  // Outdated display driver (machines not on latest driver)
  const allDrivers = Object.values(details).map(m=>m.displayDriver).filter(Boolean);
  const latestDriver = allDrivers.length ? allDrivers.sort().reverse()[0] : null;
  const needsDriver = latestDriver ? Object.entries(details).filter(([,m])=>m.displayDriver && m.displayDriver !== latestDriver) : [];

  // Long uptime (>30 days without reboot ‚Äî risky)
  const longUptime = Object.entries(details).filter(([,m])=>{
    if(!m.uptime) return false;
    const parts = m.uptime.split(':');
    if(parts.length >= 1) {
      // uptime format HH:MM:SS or days.HH:MM:SS
      const str = m.uptime;
      const dayMatch = str.match(/^(\d+)\./);
      if(dayMatch) return parseInt(dayMatch[1]) > 30;
    }
    return false;
  });

  const alertCards = [];

  if(needsWinUpdate.length > 0) {
    alertCards.push(fleetAlertCard(
      '#a855f7', 'ü™ü', 'Windows Updates Pending',
      needsWinUpdate.length+' machines',
      needsWinUpdate.slice(0,6).map(([h,m])=>`<span class="alert-host">${h}</span><span style="color:#64748b;font-size:10px">${m.winUpdatePending||''}</span>`).join(''),
      needsWinUpdate.length > 6 ? `+ ${needsWinUpdate.length-6} more` : '',
      'Run via GoTo Resolve: Install-Module PSWindowsUpdate -Force; Get-WindowsUpdate -Install -AcceptAll -AutoReboot'
    ));
  }

  if(lowDisk.length > 0) {
    alertCards.push(fleetAlertCard(
      '#eab308', 'üíø', 'Low Disk Space',
      lowDisk.length+' machines under 20 GB free',
      lowDisk.slice(0,6).map(([h,m])=>`<span class="alert-host">${h}</span><span style="color:#eab308;font-size:10px">${parseFloat(m.diskFree).toFixed(1)} GB</span>`).join(''),
      lowDisk.length > 6 ? `+ ${lowDisk.length-6} more` : '',
      'Run: Remove-Item C:\\Windows\\Temp\\* -Recurse -Force; cleanmgr /sagerun:1'
    ));
  }

  if(needsDriver.length > 5) {
    alertCards.push(fleetAlertCard(
      '#06b6d4', 'üñ•Ô∏è', 'Display Driver Updates',
      needsDriver.length+' machines not on latest driver',
      needsDriver.slice(0,6).map(([h,m])=>`<span class="alert-host">${h}</span><span style="color:#64748b;font-size:10px">${(m.displayDriver||'').split(' ').pop()}</span>`).join(''),
      needsDriver.length > 6 ? `+ ${needsDriver.length-6} more` : '',
      'Run: Get-WindowsUpdate -Category "Drivers" -Install -AcceptAll -AutoReboot'
    ));
  }

  if(longUptime.length > 0) {
    alertCards.push(fleetAlertCard(
      '#f97316', '‚è±Ô∏è', 'Long Uptime ‚Äî Reboot Overdue',
      longUptime.length+' machines up 30+ days',
      longUptime.slice(0,6).map(([h,m])=>`<span class="alert-host">${h}</span><span style="color:#f97316;font-size:10px">${m.uptime}</span>`).join(''),
      longUptime.length > 6 ? `+ ${longUptime.length-6} more` : '',
      'Run: shutdown /r /t 300 /c "Scheduled maintenance reboot"'
    ));
  }

  const alertContainer = document.getElementById('fleetAlerts');
  if(alertContainer) alertContainer.innerHTML = alertCards.join('') || '';
}

function fleetAlertCard(color, icon, title, subtitle, machineHtml, more, cmd) {
  return `<div style="background:var(--surface);border:1px solid ${color}33;border-radius:12px;padding:18px 20px">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <span style="font-size:20px">${icon}</span>
      <div>
        <div style="color:${color};font-weight:700;font-size:14px">${title}</div>
        <div style="color:#64748b;font-size:11px">${subtitle}</div>
      </div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">${machineHtml}</div>
    ${more?`<div style="color:#475569;font-size:11px;margin-bottom:10px">${more}</div>`:''}
    <details style="margin-top:4px">
      <summary style="color:${color};font-size:11px;cursor:pointer;user-select:none">‚ñ∂ Quick fix command</summary>
      <pre style="background:#0a0f1a;border:1px solid #1e3a5f;border-radius:6px;padding:10px;font-size:11px;color:#22c55e;margin-top:8px;overflow-x:auto;white-space:pre-wrap">${cmd}</pre>
    </details>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ MACHINES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let machineSort = {col:'crashes', dir:-1};
let selectedMachines = new Set();

function sortMachines(col) {
  if(machineSort.col===col) machineSort.dir*=-1;
  else { machineSort.col=col; machineSort.dir=col==='crashes'?-1:1; }
  renderMachines();
}

function filterMachines() { renderMachines(); }

function toggleSelectAll(cb) {
  const boxes = document.querySelectorAll('.machine-cb');
  boxes.forEach(b=>{ b.checked=cb.checked; if(cb.checked) selectedMachines.add(b.dataset.host); else selectedMachines.delete(b.dataset.host); });
  updateBulkBar();
}

function toggleSelect(host, cb) {
  if(cb.checked) selectedMachines.add(host); else selectedMachines.delete(host);
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  const count = document.getElementById('bulkCount');
  bar.style.display = selectedMachines.size>0?'flex':'none';
  count.textContent = selectedMachines.size+' selected';
}

function exportCSV() {
  const details = DATA.machineDetails||{};
  const crashes = DATA.crashesPerMachine||{};
  const hosts = selectedMachines.size>0 ? [...selectedMachines] : Object.keys(crashes);
  const headers = ['Hostname','Crashes','Risk','BIOS','BIOSDate','OSBuild','OSFull','Manufacturer','Model','Serial','IP','MAC','RAM_GB','DiskFree_GB','DisplayDriver','LastKB','WinUpdatePending','LastRebootReason','Uptime','AppspaceVersion','ScriptVersion','ScalaArtifacts','LastCrash'];
  const rows = hosts.map(h=>{
    const m=details[h]||{}, c=crashes[h]||0;
    const risk=c>=10?'CRITICAL':c>=6?'HIGH':c>=4?'MEDIUM':'LOW';
    return [h,c,risk,m.bios||'',m.biosReleaseDate||'',m.osBuild||'',m.osVersionFull||'',m.manufacturer||'',m.model||'',m.serialNumber||'',m.ipAddress||'',m.macAddress||'',(m.totalRAM||''),(m.diskFree||''),m.displayDriver||'',m.lastUpdateKB||'',m.winUpdatePending||'',m.lastRebootReason||'',m.uptime||'',m.appspaceVersion||'',m.scriptVersion||'',m.scalaArtifacts||'',m.lastSeen||''].map(v=>'"'+String(v).replace(/"/g,'""')+'"');
  });
  const csv = [headers.join(','),...rows.map(r=>r.join(','))].join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='takeda-crash-report-'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
}

function viewSelectedInSP() {
  const spBase='https://proneweratech.sharepoint.com/sites/JustinsSharepointSite/Lists/DeviceCrashEvents/AllItems.aspx';
  if(selectedMachines.size===1) {
    const host=[...selectedMachines][0];
    window.open(spBase+'?FilterField1=Title&FilterValue1='+encodeURIComponent(host),'_blank');
  } else {
    window.open(spBase,'_blank');
    alert('SharePoint opened. Use the Filter by column feature to select: '+[...selectedMachines].join(', '));
  }
}

function renderMachines() {
  const searchVal = (document.getElementById('machineSearch')||{value:''}).value.toLowerCase();
  const allMachines = Object.entries(DATA.crashesPerMachine||{}).filter(([h])=>!searchVal||h.toLowerCase().includes(searchVal));

  const validBiosRx = /^\d+\.\d+[\.\d]*$/;
  const allBios = Object.values(DATA.machineDetails||{}).map(m=>m.bios).filter(b=>b&&validBiosRx.test(b.trim()));
  const latestBios = allBios.sort((a,b)=>{
    const pa=a.split('.').map(Number),pb=b.split('.').map(Number);
    for(let i=0;i<3;i++){if((pa[i]||0)!==(pb[i]||0))return(pb[i]||0)-(pa[i]||0);}return 0;
  })[0]||'';

  const machines = allMachines.sort((a,b)=>{
    const ma=(DATA.machineDetails||{})[a[0]]||{},mb=(DATA.machineDetails||{})[b[0]]||{};
    const col=machineSort.col,d=machineSort.dir;
    if(col==='crashes')return d*(a[1]-b[1]);
    if(col==='host')return d*a[0].localeCompare(b[0]);
    if(col==='bios')return d*(ma.bios||'').localeCompare(mb.bios||'');
    if(col==='os')return d*(ma.osBuild||'').localeCompare(mb.osBuild||'');
    if(col==='last')return d*(new Date(ma.lastSeen||0)-new Date(mb.lastSeen||0));
    return 0;
  });

  const colors = machines.map(([,c])=>c>=10?'#ef4444':c>=6?'#f97316':c>=4?'#eab308':'#3b82f6');
  if(machineChartInst) machineChartInst.destroy();
  machineChartInst = new Chart(document.getElementById('machineChart'),{
    type:'bar',
    data:{labels:machines.map(([h])=>h),datasets:[{data:machines.map(([,c])=>c),backgroundColor:colors,borderRadius:[4,4,0,0],borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:9},maxRotation:60}},y:{beginAtZero:true,ticks:{font:{size:10}}}}}
  });

  document.querySelectorAll('.sort-th').forEach(th=>{
    const c=th.dataset.col;
    th.innerHTML=th.dataset.label+(machineSort.col===c?(machineSort.dir===-1?' ‚Üì':' ‚Üë'):' ‚Üï');
  });

  const spBase='https://proneweratech.sharepoint.com/sites/JustinsSharepointSite/Lists/DeviceCrashEvents/AllItems.aspx';
  const sfcLink='https://support.microsoft.com/en-us/topic/use-the-system-file-checker-tool-to-repair-missing-or-corrupted-system-files-79aa86cb-ca52-166a-92a3-966e85d4094e';
  const winUpdateLink='https://support.microsoft.com/en-us/windows/update-windows-3c5ae7fc';

  const tbody=document.getElementById('machineTableBody');
  tbody.innerHTML=machines.map(([host,count],idx)=>{
    const meta=(DATA.machineDetails||{})[host]||{};
    const biosVer=meta.bios||'';
    const isOutdated=biosVer&&latestBios&&validBiosRx.test(biosVer)&&biosVer!==latestBios;
    const biosDisplay=biosVer?(isOutdated?biosVer+' ‚ö†Ô∏è':biosVer+' ‚úì'):'‚Äî';
    const biosColor=isOutdated?'#f97316':biosVer?'#22c55e':'#64748b';
    const needsRepair=(DATA.startupRepairMachines||[]).includes(host);
    const risk=count>=10?['CRITICAL','#ef4444']:count>=6?['HIGH','#f97316']:count>=4?['MEDIUM','#eab308']:['LOW','#3b82f6'];
    const lastSeen=meta.lastSeen?new Date(meta.lastSeen):null;
    const daysAgo=lastSeen?Math.floor((Date.now()-lastSeen)/86400000):null;
    const lastSeenStr=daysAgo===null?'‚Äî':daysAgo===0?'Today':daysAgo===1?'Yesterday':daysAgo+'d ago';
    const lastSeenColor=daysAgo!==null&&daysAgo<=1?'#ef4444':daysAgo!==null&&daysAgo<=7?'#f97316':'#64748b';
    const mfr=(meta.manufacturer||'').toLowerCase();
    const model=meta.model||'';
    let biosLink;
    if(mfr.includes('dell')) biosLink='https://www.dell.com/support/home/en-us?app=drivers&query='+encodeURIComponent(model)+'+BIOS';
    else if(mfr.includes('hp')||mfr.includes('hewlett')) biosLink='https://support.hp.com/us-en/drivers/selfservice/'+encodeURIComponent(model);
    else if(mfr.includes('lenovo')) biosLink='https://support.lenovo.com/us/en/products/'+encodeURIComponent(model);
    else biosLink='https://www.google.com/search?q='+encodeURIComponent((meta.manufacturer||'')+' '+model+' BIOS firmware update');
    const winPending=meta.winUpdatePending||'';
    const hasWinUpdate=winPending&&winPending.toLowerCase()!=='none'&&winPending.toLowerCase()!=='false'&&winPending!=='0'&&winPending!=='';
    const archiveUrl=spBase+'?FilterField1=Title&FilterValue1='+encodeURIComponent(host);
    const actions=[];
    if(isOutdated) actions.push('<a href="'+biosLink+'" target="_blank" style="color:#f97316;text-decoration:underline dotted;white-space:nowrap">BIOS '+latestBios+' ‚Üó</a>');
    if(hasWinUpdate) actions.push('<a href="'+winUpdateLink+'" target="_blank" style="color:#a855f7;text-decoration:underline dotted;white-space:nowrap">Win Updates ‚Üó</a>');
    if(needsRepair) actions.push('<a href="'+sfcLink+'" target="_blank" style="color:#ef4444;text-decoration:underline dotted;white-space:nowrap">sfc /scannow ‚Üó</a>');
    if(!actions.length) actions.push('<span style="color:#22c55e">‚úì No action</span>');
    actions.push('<a href="'+archiveUrl+'" target="_blank" style="color:#60a5fa;text-decoration:underline dotted;white-space:nowrap;font-size:10px">üìã SP ‚Üó</a>');
    const isChecked=selectedMachines.has(host);

    const scalaRaw=meta.scalaArtifacts||'';
    const scalaItems=scalaRaw?scalaRaw.split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean):[];
    const scalaDisplay=scalaItems.length?scalaItems.map(s=>'<span style="background:#1e293b;padding:2px 6px;border-radius:3px;margin:2px;display:inline-block;font-size:10px">'+s+'</span>').join(''):'<span style="color:#64748b">None detected</span>';
    const det=v=>v||'';

    const mainRow='<tr class="machine-row" style="cursor:pointer">'+
      '<td onclick="event.stopPropagation()"><input type="checkbox" class="machine-cb" data-host="'+host+'" '+(isChecked?'checked':'')+' onchange="toggleSelect(\''+host+'\',this)" style="cursor:pointer;accent-color:#3b82f6"></td>'+
      '<td class="mono" style="color:#e2e8f0" onclick="toggleExpand(\'exp-'+idx+'\')">'+host+'</td>'+
      '<td class="mono" style="font-weight:700;color:'+risk[1]+'" onclick="toggleExpand(\'exp-'+idx+'\')">'+count+'</td>'+
      '<td onclick="toggleExpand(\'exp-'+idx+'\')"><span class="badge" style="color:'+risk[1]+';background:'+risk[1]+'22">'+risk[0]+'</span></td>'+
      '<td class="mono" style="color:'+biosColor+';font-size:11px" onclick="toggleExpand(\'exp-'+idx+'\')">'+biosDisplay+'</td>'+
      '<td class="mono" style="color:#94a3b8" onclick="toggleExpand(\'exp-'+idx+'\')">'+det(meta.osBuild)+'</td>'+
      '<td class="mono" style="color:'+lastSeenColor+';font-size:11px" onclick="toggleExpand(\'exp-'+idx+'\')">'+lastSeenStr+'</td>'+
      '<td style="font-size:11px">'+actions.join('<br>')+'</td>'+
      '</tr>';

    const detailRow='<tr id="exp-'+idx+'" style="display:none">'+
      '<td colspan="8" style="padding:0">'+
      '<div style="background:#0a0f1a;border:1px solid #1e3a5f;border-radius:8px;margin:4px 8px;padding:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">'+
      drow('üñ•Ô∏è Model',(meta.manufacturer||'')+(meta.model?' ‚Äì '+meta.model:''))+
      drow('üî¢ Serial',meta.serialNumber)+
      drow('üåê IP',meta.ipAddress)+
      drow('üíæ RAM',meta.totalRAM?meta.totalRAM+' GB':'')+
      drow('üíø Disk Free',meta.diskFree?meta.diskFree+' GB':'')+
      drow('üñ±Ô∏è Display Driver',meta.displayDriver)+
      drow('üîÑ Last KB',meta.lastUpdateKB)+
      drow('‚è≥ Win Updates Pending',meta.winUpdatePending||'None')+
      drow('‚è±Ô∏è Uptime at Report',meta.uptime)+
      drow('üìã Last Reboot Reason',meta.lastRebootReason)+
      drow('üè∑Ô∏è OS Full',meta.osVersionFull)+
      drow('üì¶ Appspace Version',meta.appspaceVersion)+
      drow('üìù Script Version',meta.scriptVersion)+
      drow('üîë MAC',meta.macAddress)+
      drow('üìÖ BIOS Date',meta.biosReleaseDate)+
      '<div style="grid-column:1/-1"><div style="color:#64748b;font-size:10px;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Scala Artifacts</div><div>'+scalaDisplay+'</div></div>'+
      '<div style="grid-column:1/-1;display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">'+
      '<a href="'+archiveUrl+'" target="_blank" style="background:#1e3a5f;color:#60a5fa;padding:6px 14px;border-radius:6px;font-size:11px;text-decoration:none;border:1px solid #3b82f633">üìã View in SharePoint ‚Üó</a>'+
      (isOutdated?'<a href="'+biosLink+'" target="_blank" style="background:#431407;color:#f97316;padding:6px 14px;border-radius:6px;font-size:11px;text-decoration:none;border:1px solid #f9731633">‚¨Ü Get BIOS '+latestBios+' ‚Üó</a>':'')+
      (needsRepair?'<a href="'+sfcLink+'" target="_blank" style="background:#450a0a;color:#ef4444;padding:6px 14px;border-radius:6px;font-size:11px;text-decoration:none;border:1px solid #ef444433">üîß SFC /scannow docs ‚Üó</a>':'')+
      '<button onclick="downloadScript(\''+host+'\')" style="background:#14532d;color:#22c55e;padding:6px 14px;border-radius:6px;font-size:11px;border:1px solid #22c55e33;cursor:pointer">‚¨á Download Fix Script (.ps1)</button>'+
      '</div></div></td></tr>';

    return mainRow+detailRow;
  }).join('');
}

function drow(label,val){
  if(!val) return '';
  return '<div><div style="color:#64748b;font-size:10px;text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px">'+label+'</div><div style="color:#e2e8f0;font-size:12px;font-family:monospace;word-break:break-word">'+val+'</div></div>';
}

function toggleExpand(id){
  const row=document.getElementById(id);
  if(row) row.style.display=row.style.display==='none'?'table-row':'none';
}


// ‚îÄ‚îÄ‚îÄ FINDINGS (dynamically generated from live data) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFindings() {
  const findings = generateFindings();
  document.getElementById('findingsHeader').textContent =
    `üîç Analysis based on ${DATA.total} real crash events from ${DATA.uniqueMachines} Takeda DS machines. Click any finding to expand remediation steps.`;

  const container = document.getElementById('findingsContainer');
  container.innerHTML = '';
  findings.forEach((f,i)=>{
    const div = document.createElement('div');
    div.className='finding';
    div.style.cssText=`background:${f.color}11;border:1px solid ${f.color}33`;
    div.innerHTML=`
      <div class="finding-header">
        <div class="finding-icon">${f.icon}</div>
        <div class="finding-body">
          <div>
            <span class="finding-severity" style="color:${f.color};background:${f.color}22">${f.sev}</span>
            <span class="finding-count">${f.count}</span>
          </div>
          <div class="finding-title">${f.title}</div>
          <div class="finding-detail">${f.detail}</div>
          <div class="steps" id="steps-${i}">
            <div class="steps-title">Recommended Steps</div>
            ${f.steps.map((s,j)=>`<div class="step">
              <div class="step-num" style="background:${f.color}33;color:${f.color}">${j+1}</div>
              <div class="step-text">${s}</div>
            </div>`).join('')}
          </div>
          <div class="finding-toggle" id="toggle-${i}">‚ñº Click to see fix steps</div>
        </div>
      </div>`;
    div.onclick=()=>{
      const steps=document.getElementById('steps-'+i);
      const toggle=document.getElementById('toggle-'+i);
      const open=steps.classList.toggle('open');
      toggle.textContent=open?'‚ñ≤ Click to collapse':'‚ñº Click to see fix steps';
    };
    container.appendChild(div);
  });
}

function generateFindings() {
  const findings = [];
  const total = DATA.total || 0;
  const ev41 = (DATA.eventIds||{})['41'] || 0;
  const ev6008 = (DATA.eventIds||{})['6008'] || 0;
  const ev1001 = (DATA.eventIds||{})['1001'] || 0;
  const repairMachines = DATA.startupRepairMachines || [];
  const outdatedMachines = DATA.biosOutdatedMachines || [];
  const topCrasher = DATA.topCrasher || {};
  const outdatedPct = DATA.outdatedBiosPct || 0;
  const outdatedCount = DATA.outdatedBiosCount || 0;
  const details = DATA.machineDetails || {};
  const crashes = DATA.crashesPerMachine || {};

  // ‚îÄ‚îÄ Finding 1: Unexpected Power Loss (Event 41 + 6008) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(ev41 > 0 || ev6008 > 0) {
    const pct = Math.round(((ev41+ev6008)/total)*100);
    findings.push({
      sev:'CRITICAL', color:'#ef4444', icon:'‚ö°',
      title:'Widespread Unexpected Power Loss / Kernel Panics',
      count:`${ev41+ev6008} events (${pct}% of all crashes) ‚Äî Event 41 + Event 6008`,
      detail:`Every single machine is losing power without a clean shutdown. Event ID 41 = "Kernel-Power: The system has rebooted without cleanly shutting down first." Event ID 6008 = "The previous system shutdown was unexpected." These two together mean the OS had no warning ‚Äî no software crash, no graceful reboot. This is a hardware-level power interruption at the outlet or power supply level, affecting ${DATA.uniqueMachines} machines across the entire Takeda deployment. Appspace/Scala cannot recover from abrupt cuts ‚Äî the player restarts into a corrupted state.`,
      steps:[
        'IMMEDIATE: Audit power infrastructure at every display site. DS players should be on dedicated circuits, not shared with monitors, projectors, or AV equipment that causes voltage sags on power-on.',
        'QUICK WIN: Enable "AC Power Recovery" in BIOS ‚Üí set to "Power On" so machines self-recover after outages without manual intervention. This alone eliminates the need for site visits after power events.',
        'DEPLOY via GoTo Resolve terminal ‚Äî run on all machines:\n  powercfg /change standby-timeout-ac 0\n  powercfg /change hibernate-timeout-ac 0\n  powercfg /change monitor-timeout-ac 0\n  This prevents the OS from sleeping and cutting power to the display chain.',
        'CHECK Event Log for power event timestamps: Get-WinEvent -LogName System | Where-Object {$_.Id -eq 41} | Select -First 20 | Format-List TimeCreated,Message ‚Äî look for time patterns (overnight, early morning) that correlate with cleaning crews, HVAC cycles, or facility power events.',
        'LONG TERM: Deploy UPS (APC BE600M1 or similar, ~$60/unit) at every display location. Even a 5-minute runtime gives the player time to gracefully shut down.',
        'NOTIFY Takeda facilities: request electrician inspection of shared circuits in high-crash locations. Voltage sag logs from a UPS would confirm the root cause.'
      ]
    });
  }

  // ‚îÄ‚îÄ Finding 2: Outdated BIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(outdatedMachines.length > 0) {
    // Get model info from first outdated machine
    const sampleMeta = details[outdatedMachines[0]] || {};
    const mfr = sampleMeta.manufacturer || 'manufacturer';
    const model = sampleMeta.model || 'device';
    findings.push({
      sev:'HIGH', color:'#f97316', icon:'üîß',
      title:`Outdated BIOS ‚Äî ${outdatedMachines.length} Machines Still on Older Version`,
      count:`${outdatedCount} crash events from BIOS-outdated machines (${outdatedPct}% of fleet)`,
      detail:`${outdatedMachines.length} machines are running an older BIOS version. BIOS updates for ${mfr} ${model} often include power management fixes, C-state corrections, and stability patches directly relevant to Event 41 crashes. Outdated BIOS can cause improper power state transitions ‚Äî the CPU enters a low-power state it can't exit cleanly, triggering a hard reset that looks identical to a power outage.\n\nAffected machines: ${outdatedMachines.slice(0,8).join(', ')}${outdatedMachines.length>8?' + '+(outdatedMachines.length-8)+' more':''}`,
      steps:[
        `STEP 1 ‚Äî Download latest BIOS from ${mfr.toLowerCase().includes('dell')?'dell.com/support':mfr.toLowerCase().includes('hp')?'support.hp.com':'manufacturer support site'} for model: ${model}. Look for release notes mentioning "power management", "unexpected shutdown", or "stability fixes".`,
        'STEP 2 ‚Äî Test on one machine first. Deploy via GoTo Resolve ‚Üí Terminal:\n  # Silent Dell BIOS update example:\n  .\\BIOS_UPDATE.exe /s /r /l=C:\\bios_update.log\n  # Check log after reboot:\n  Get-Content C:\\bios_update.log',
        'STEP 3 ‚Äî Verify BIOS version after update:\n  (Get-WmiObject -Class Win32_BIOS).SMBIOSBIOSVersion\n  # Or:\n  wmic bios get smbiosbiosversion',
        `STEP 4 ‚Äî After BIOS update on all ${outdatedMachines.length} machines, monitor for 2 weeks. If crash rate drops, BIOS was the primary cause. If not, power infrastructure is the issue.`,
        'IMPORTANT: Ensure machines do NOT lose power during BIOS flash ‚Äî this will brick the device. Confirm UPS or stable power before deploying.'
      ]
    });
  }

  // ‚îÄ‚îÄ Finding 3: Startup Repair / File System Corruption ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(repairMachines.length > 0) {
    findings.push({
      sev:'HIGH', color:'#f97316', icon:'üîÅ',
      title:`${repairMachines.length} Machines Have File System Corruption`,
      count:`${ev1001} Event ID 1001 occurrences ‚Äî Windows Startup Repair triggered`,
      detail:`Event ID 1001 "BugCheck" means Windows triggered its Startup Repair tool after a crash ‚Äî the OS could not boot normally. Each of these ${repairMachines.length} machines has sustained enough repeated abrupt shutdowns that the NTFS file system has become corrupted. Without remediation, the next crash may result in a machine that cannot boot at all, requiring a full OS reinstall on-site.\n\nMachines requiring immediate action: ${repairMachines.slice(0,6).join(', ')}${repairMachines.length>6?' + '+(repairMachines.length-6)+' more':''}`,
      steps:[
        'STEP 1 ‚Äî Run System File Checker via GoTo Resolve terminal (run as SYSTEM):\n  sfc /scannow\n  # Wait for completion (5-15 min). Look for "found corrupt files and successfully repaired" vs "could not fix".',
        'STEP 2 ‚Äî If sfc finds unfixable corruption, run DISM:\n  DISM /Online /Cleanup-Image /CheckHealth\n  DISM /Online /Cleanup-Image /ScanHealth\n  DISM /Online /Cleanup-Image /RestoreHealth\n  # This downloads clean Windows component files from Microsoft to replace corrupted ones.',
        'STEP 3 ‚Äî Check SMART disk health (failing drive = certain data loss):\n  wmic diskdrive get status,model,size\n  # If status is anything other than "OK", replace the drive immediately.',
        'STEP 4 ‚Äî Enable automatic disk check on next boot:\n  chkdsk C: /f /r /x\n  # Answer Y to schedule on next restart. This finds and marks bad sectors.',
        `STEP 5 ‚Äî Machines with 10+ crashes (${topCrasher.host} has ${topCrasher.count}) should be prioritized for reimaging. The cumulative file system damage from this many abrupt shutdowns may not be fully reversible with sfc/DISM.`,
        'MONITORING: After repair, check the Application event log for Wininit source "Windows Resource Protection" to confirm SFC completed successfully.'
      ]
    });
  }

  // ‚îÄ‚îÄ Finding 4: Top crasher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(topCrasher.host && topCrasher.count >= 6) {
    const meta = details[topCrasher.host] || {};
    const isOutdatedBios = outdatedMachines.includes(topCrasher.host);
    const needsRepair = repairMachines.includes(topCrasher.host);
    const issues = [];
    if(isOutdatedBios) issues.push('outdated BIOS');
    if(needsRepair) issues.push('file system corruption (Event 1001)');
    findings.push({
      sev:'HIGH', color:'#f97316', icon:'üìà',
      title:`${topCrasher.host} ‚Äî Highest Risk Machine (${topCrasher.count} crashes)`,
      count:`${topCrasher.count} crashes ‚Äî ${(30/topCrasher.count).toFixed(1)} day average between crashes`,
      detail:`${topCrasher.host} has crashed ${topCrasher.count} times ‚Äî more than any other machine in the fleet. At this rate, it crashes roughly every ${(30/topCrasher.count).toFixed(1)} days. ${issues.length?'It also has: '+issues.join(' and ')+'.':''} ${meta.ipAddress?'IP: '+meta.ipAddress+'.':''} ${meta.osBuild?'OS Build: '+meta.osBuild+'.':''} This machine is on a trajectory to fail completely and will need on-site intervention if not addressed remotely first.`,
      steps:[
        `REMOTE TRIAGE ‚Äî Connect via GoTo Resolve and run:\n  # Check recent crash events:\n  Get-WinEvent -LogName System -MaxEvents 100 | Where-Object {$_.Id -in 41,6008,1001} | Select TimeCreated,Id,Message | Format-Table -Wrap\n  # Check power events:\n  Get-WinEvent -LogName System | Where-Object {$_.Id -eq 41} | Select -First 5 | FL`,
        `POWER CHECK ‚Äî Inspect the specific outlet and power strip at ${topCrasher.host}'s physical location. This machine's frequency suggests a localized power issue, not a fleet-wide one.`,
        isOutdatedBios?`BIOS UPDATE ‚Äî This machine is on an older BIOS. Update it first:\n  wmic bios get smbiosbiosversion\n  # Then deploy manufacturer BIOS update silently via GoTo Resolve`:'BIOS is current ‚Äî rule out power management driver issues:\n  Get-WmiObject Win32_PnPSignedDriver | Where-Object{$_.DeviceName -like "*Power*"} | FL',
        needsRepair?`FILE SYSTEM REPAIR ‚Äî This machine has Event 1001 corruption. Run immediately:\n  sfc /scannow\n  DISM /Online /Cleanup-Image /RestoreHealth`:'Check SMART status: wmic diskdrive get status,model ‚Äî confirm drive is healthy.',
        `ESCALATE ‚Äî If crashes continue after BIOS update + sfc repair, request Takeda on-site inspection of the physical installation and power source. Consider proactive replacement: ${topCrasher.count} crashes in 30 days is terminal trajectory.`
      ]
    });
  }

  // ‚îÄ‚îÄ Finding 5: Crash cluster ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const clusterDate = Object.entries(DATA.timeline||{}).find(([,v])=>v>=8);
  if(clusterDate) {
    findings.push({
      sev:'MEDIUM', color:'#3b82f6', icon:'üìÖ',
      title:`Crash Cluster on ${clusterDate[0]} ‚Äî Possible Site-Wide Power Event`,
      count:`${clusterDate[1]} machines crashed in a single day`,
      detail:`${clusterDate[1]} machines all crashed on ${clusterDate[0]}. When multiple unrelated machines crash within hours of each other, this almost always indicates a facility-level event: brief power outage, voltage sag from HVAC startup, circuit breaker trip, or UPS failover. This is not a software issue. The machines are fine ‚Äî the power infrastructure needs to be addressed.`,
      steps:[
        `CORRELATE ‚Äî Check exact crash times for ${clusterDate[0]}:\n  Get-WinEvent -LogName System | Where-Object {$_.Id -eq 41 -and $_.TimeCreated.Date -eq [DateTime]"${clusterDate[0]}"} | Select TimeCreated,Message | Sort TimeCreated`,
        'CONTACT Takeda facilities team with the exact timestamp. Ask: "Was there any power maintenance, HVAC startup, generator test, or electrical work on this date?" Facilities often do not log brief outages.',
        'REQUEST power quality data from the building BMS (Building Management System) if available ‚Äî look for voltage sags or spikes in the 5-10 minute window around the crash times.',
        'PREVENTIVE: Any location that experienced this cluster event should be first priority for UPS installation.',
        'DOCUMENT this cluster with the crash times and machine list as evidence for Takeda facilities escalation. A single-day cluster of 8+ machines is compelling evidence of a facility infrastructure problem, not a player software issue.'
      ]
    });
  }

  // ‚îÄ‚îÄ Finding 6: Driver health ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const machinesWithOldDriver = Object.entries(details).filter(([,m])=>
    m.displayDriver && m.displayDriver.toLowerCase().includes('v31.0.101') // known older Intel driver
  );
  if(machinesWithOldDriver.length > 5) {
    findings.push({
      sev:'LOW', color:'#a855f7', icon:'üñ•Ô∏è',
      title:`Display Driver Version Consistency Check`,
      count:`${machinesWithOldDriver.length} machines on older display driver`,
      detail:`${machinesWithOldDriver.length} machines are running an older Intel UHD display driver. While display drivers are not typically the cause of Event 41 crashes (which are power-related), outdated GPU drivers can cause memory management issues and contribute to system instability. Keeping drivers consistent across the fleet also simplifies troubleshooting.`,
      steps:[
        'CHECK driver version on all machines:\n  Get-WmiObject Win32_PnPSignedDriver | Where-Object{$_.DeviceName -like "*Intel*UHD*"} | Select DeviceName,DriverVersion',
        'UPDATE via Windows Update or Intel Driver Support Assistant:\n  # Force Windows Update for drivers:\n  Install-Module -Name PSWindowsUpdate -Force\n  Get-WindowsUpdate -Category "Drivers" -Install -AcceptAll -AutoReboot',
        'DEPLOY via GoTo Resolve to all machines in a maintenance window (non-business hours) ‚Äî display driver updates require a reboot.',
        'VERIFY after update:\n  (Get-WmiObject Win32_PnPSignedDriver | Where-Object{$_.DeviceName -like "*UHD*"}).DriverVersion'
      ]
    });
  }

  // ‚îÄ‚îÄ Finding 7: Disk space warning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const lowDiskMachines = Object.entries(details).filter(([,m])=>m.diskFree && parseFloat(m.diskFree)<20);
  if(lowDiskMachines.length > 0) {
    findings.push({
      sev:'LOW', color:'#eab308', icon:'üíø',
      title:`${lowDiskMachines.length} Machines Low on Disk Space (<20GB Free)`,
      count:`${lowDiskMachines.map(([h,m])=>h+' ('+m.diskFree+'GB)').slice(0,4).join(', ')}${lowDiskMachines.length>4?' + more':''}`,
      detail:`Low disk space prevents Windows from writing crash dump files, which means if these machines crash again you lose the diagnostic data. It can also prevent Windows Update, SFC repair, and DISM from running successfully. Signage players accumulate logs and cached content over time.`,
      steps:[
        'QUICK CLEANUP via GoTo Resolve terminal:\n  # Clear Windows temp files:\n  Remove-Item -Path "C:\\Windows\\Temp\\*" -Recurse -Force -ErrorAction SilentlyContinue\n  Remove-Item -Path "$env:TEMP\\*" -Recurse -Force -ErrorAction SilentlyContinue\n  # Run Disk Cleanup silently:\n  cleanmgr /sagerun:1',
        'CHECK what is consuming space:\n  Get-ChildItem C:\\ -Directory | ForEach-Object { $size = (Get-ChildItem $_.FullName -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum; [PSCustomObject]@{Folder=$_.Name; SizeGB=[math]::Round($size/1GB,2)} } | Sort-Object SizeGB -Descending | Select -First 10',
        'CLEAR Windows Update cache (often 2-10GB):\n  Stop-Service wuauserv\n  Remove-Item "C:\\Windows\\SoftwareDistribution\\*" -Recurse -Force\n  Start-Service wuauserv',
        'CLEAR Appspace/Scala cache if large:\n  # Check Appspace cache location (typically C:\\ProgramData\\Appspace)\n  Get-ChildItem "C:\\ProgramData\\Appspace" -Recurse | Measure-Object -Property Length -Sum'
      ]
    });
  }

  return findings;
}


// ‚îÄ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(id, btn) {
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  btn.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ AI ASSIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setQ(q){ document.getElementById('aiInput').value=q; }

function saveKey() {
  const key = (document.getElementById('apiKeyInput')||{value:''}).value.trim();
  // Accept any key starting with sk- (Anthropic may issue various formats)
  if(!key || !key.startsWith('sk-')) {
    document.getElementById('keyStatus').innerHTML = '<span style="color:#ef4444">‚ùå Must start with sk-</span>';
    return;
  }
  window._savedApiKey = key;
  // Clear the input so the key isn't sitting in the DOM
  document.getElementById('apiKeyInput').value = '';
  document.getElementById('keyStatus').innerHTML = '<span style="color:#22c55e">‚úì Key saved in memory</span>';
}

async function askAI() {
  const query = document.getElementById('aiInput').value.trim();
  // Check input field first (in case they typed but didn't click Save), then saved key
  const inputKey = (document.getElementById('apiKeyInput')||{value:''}).value.trim();
  const apiKey = inputKey || window._savedApiKey || '';
  if(!apiKey) {
    document.getElementById('aiResponseBox').style.display='block';
    document.getElementById('aiResponseText').innerHTML='<span style="color:#f97316">‚ö†Ô∏è Paste your Anthropic API key above and click <strong>Save</strong>.<br><br>' +
      'To get a key:<br>1. Go to <a href="https://console.anthropic.com" target="_blank" style="color:#60a5fa">console.anthropic.com</a><br>' +
      '2. Sign up / log in<br>3. Click <strong>API Keys</strong> ‚Üí <strong>Create Key</strong><br>' +
      '4. Copy the key (starts with sk-ant-) and paste it above<br>5. Set a $5 monthly spend limit under Billing for safety</span>';
    return;
  }
  if(!query) return;
  const btn = document.getElementById('aiBtn');
  const box = document.getElementById('aiResponseBox');
  const text = document.getElementById('aiResponseText');
  btn.disabled = true;
  btn.innerHTML = '‚è≥ Thinking...';
  box.style.display = 'block';
  text.innerHTML = '<span style="color:#64748b">Calling Claude API...</span>';
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 1500,
        system: 'You are an expert Windows IT engineer for managed IT services. ' +
                'Remote management is done via GoTo Resolve terminal (runs as SYSTEM). ' +
                'Fleet context: ' + aiContext + ' ' +
                'Give concise actionable answers with exact PowerShell/CMD commands. ' +
                'For scripts, include scheduling via Task Scheduler at 3:00 AM. ' +
                'Format code blocks with triple backticks and language tag.',
        messages: [{role: 'user', content: query}]
      })
    });
    const data = await res.json();
    if (!res.ok) {
      const msg = (data.error && data.error.message) ? data.error.message : JSON.stringify(data);
      text.innerHTML = '<span style="color:#ef4444">API Error ' + res.status + ': ' + msg + '</span>';
      if(res.status === 401) {
        text.innerHTML += '<br><br><span style="color:#94a3b8">Your key may have been invalidated. Keys shared in any chat or public page are auto-revoked by Anthropic security.<br>' +
          'Create a brand new key at <a href="https://console.anthropic.com" target="_blank" style="color:#60a5fa">console.anthropic.com</a> and paste it above.</span>';
        window._savedApiKey = '';
      }
    } else {
      const raw = (data.content && data.content[0] && data.content[0].text) ? data.content[0].text : 'No response received.';
      const html = raw
        .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre style="background:#0a0f1a;border:1px solid #1e3a5f;border-radius:6px;padding:12px;overflow-x:auto;font-size:12px;margin:10px 0;white-space:pre-wrap"><code style="color:#22c55e;font-family:monospace">$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code style="background:#1e293b;color:#22c55e;padding:1px 5px;border-radius:3px;font-family:monospace">$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong style="color:#e2e8f0">$1</strong>')
        .replace(/\n/g, '<br>');
      text.innerHTML = '<div style="color:#e2e8f0;line-height:1.7">' + html + '</div>';
    }
  } catch(e) {
    text.innerHTML = '<span style="color:#ef4444">Network error: ' + e.message + '<br>Check browser console (F12) for details.</span>';
    console.error('AI error:', e);
  }
  btn.disabled = false;
  btn.textContent = 'Ask';
}

// ‚îÄ‚îÄ‚îÄ REMEDIATION SCRIPT GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateFixScript(hostname) {
  const meta = (DATA.machineDetails||{})[hostname] || {};
  const crashes = (DATA.crashesPerMachine||{})[hostname] || 0;
  const details = DATA.machineDetails || {};

  // Determine what issues this machine has
  const validBiosRx = /^\d+\.\d+[\.\d]*$/;
  const allBios = Object.values(details).map(m=>m.bios).filter(b=>b&&validBiosRx.test(b.trim()));
  const latestBios = allBios.sort((a,b)=>{const pa=a.split('.').map(Number),pb=b.split('.').map(Number);for(let i=0;i<3;i++){if((pa[i]||0)!==(pb[i]||0))return(pb[i]||0)-(pa[i]||0);}return 0;})[0]||'';
  const isOutdated = meta.bios && latestBios && validBiosRx.test(meta.bios) && meta.bios !== latestBios;
  const needsRepair = (DATA.startupRepairMachines||[]).includes(hostname);
  const winPending = (meta.winUpdatePending||'').toLowerCase();
  const hasWinUpdate = winPending && winPending!=='none' && winPending!=='false' && winPending!=='0';
  const diskLow = meta.diskFree && parseFloat(meta.diskFree) < 20;

  const mfr = (meta.manufacturer||'').toLowerCase();
  const model = meta.model || '';

  const lines = [];
  lines.push(`# ============================================================`);
  lines.push(`# Takeda DS Crash Remediation Script`);
  lines.push(`# Machine: ${hostname}`);
  lines.push(`# Model: ${meta.manufacturer||'Unknown'} ${model}`);
  lines.push(`# BIOS: ${meta.bios||'Unknown'} | OS Build: ${meta.osBuild||'Unknown'}`);
  lines.push(`# Crashes: ${crashes} | Generated: ${new Date().toLocaleDateString()}`);
  lines.push(`#`);
  lines.push(`# HOW THIS WORKS:`);
  lines.push(`#   This file is distributed by GoTo Resolve to C:\\Scripts\\ on the machine.`);
  lines.push(`#   GTR then runs a separate one-line registration command that schedules`);
  lines.push(`#   this script to run ONCE at 3:00 AM local time tonight.`);
  lines.push(`#   Nothing in this file runs immediately. Everything runs at 3AM.`);
  lines.push(`#   After 3AM completes, the scheduled task is removed automatically.`);
  lines.push(`# ============================================================`);
  lines.push(``);
  lines.push(`$taskName = "TakedaRemediation_${hostname}"`);
  lines.push(`$LogFile  = "C:\\Logs\\TakedaRemediation_${hostname}_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"`);
  lines.push(`$null     = New-Item -ItemType Directory -Force -Path "C:\\Logs"`);
  lines.push(``);
  lines.push(`Start-Transcript -Path $LogFile -Append`);
  lines.push(`Write-Host ""`);
  lines.push(`Write-Host "=== Takeda DS Remediation ‚Äî ${hostname} ‚Äî $(Get-Date) ==="`);
  lines.push(`Write-Host "Running fixes that were identified on $(Get-Date -Format 'MM/dd/yyyy') via Crash Intelligence Dashboard"`);
  lines.push(``);

  if(diskLow) {
    lines.push(`# ‚îÄ‚îÄ DISK CLEANUP (was at ${parseFloat(meta.diskFree||0).toFixed(1)}GB free at time of script generation) ‚îÄ‚îÄ`);
    lines.push(`Write-Host "[1/5] Running disk cleanup..."`);
    lines.push(`Remove-Item -Path "C:\\Windows\\Temp\\*" -Recurse -Force -ErrorAction SilentlyContinue`);
    lines.push(`Remove-Item -Path "$env:TEMP\\*" -Recurse -Force -ErrorAction SilentlyContinue`);
    lines.push(`Stop-Service wuauserv -Force`);
    lines.push(`Remove-Item "C:\\Windows\\SoftwareDistribution\\Download\\*" -Recurse -Force -ErrorAction SilentlyContinue`);
    lines.push(`Start-Service wuauserv`);
    lines.push(`Start-Process cleanmgr -ArgumentList "/sagerun:1" -Wait`);
    lines.push(`$after = (Get-PSDrive C).Free/1GB`);
    lines.push(`Write-Host "Disk cleanup done. Free space now: $([math]::Round($after,1)) GB"`);
    lines.push(``);
  }

  if(needsRepair) {
    lines.push(`# ‚îÄ‚îÄ FILE SYSTEM REPAIR (Event 1001 detected ‚Äî Windows Startup Repair triggered) ‚îÄ‚îÄ`);
    lines.push(`Write-Host "[2/5] Running System File Checker..."`);
    lines.push(`sfc /scannow`);
    lines.push(``);
    lines.push(`Write-Host "Running DISM health restore..."`);
    lines.push(`DISM /Online /Cleanup-Image /CheckHealth`);
    lines.push(`DISM /Online /Cleanup-Image /RestoreHealth`);
    lines.push(``);
    lines.push(`Write-Host "Scheduling chkdsk for next reboot..."`);
    lines.push(`echo Y | chkdsk C: /f /r`);
    lines.push(``);
    lines.push(`$diskStatus = (Get-WmiObject Win32_DiskDrive).Status`);
    lines.push(`Write-Host "Drive SMART status: $diskStatus"`);
    lines.push(`if($diskStatus -ne "OK") { Write-Host "‚ö†Ô∏è WARNING: Drive health issue ‚Äî flag for physical replacement" }`);
    lines.push(``);
  }

  if(hasWinUpdate) {
    lines.push(`# ‚îÄ‚îÄ WINDOWS UPDATES (pending at time of script generation: ${meta.winUpdatePending||'Yes'}) ‚îÄ‚îÄ`);
    lines.push(`Write-Host "[3/5] Installing Windows Updates..."`);
    lines.push(`if(-not (Get-Module -ListAvailable PSWindowsUpdate)) {`);
    lines.push(`  Install-PackageProvider -Name NuGet -Force -Confirm:$false`);
    lines.push(`  Install-Module PSWindowsUpdate -Force -Confirm:$false`);
    lines.push(`}`);
    lines.push(`Import-Module PSWindowsUpdate`);
    lines.push(`Install-WindowsUpdate -AcceptAll -IgnoreReboot -Verbose`);
    lines.push(`Get-WindowsUpdate -Category "Drivers" -AcceptAll -IgnoreReboot -Install`);
    lines.push(`Write-Host "Windows Updates complete"`);
    lines.push(``);
  }

  if(isOutdated) {
    lines.push(`# ‚îÄ‚îÄ BIOS UPDATE NOTICE (Current: ${meta.bios||'?'} ‚Üí Latest fleet version: ${latestBios}) ‚îÄ‚îÄ`);
    lines.push(`# BIOS updates require confirmed stable power ‚Äî cannot be safely automated.`);
    lines.push(`# This block logs the current state for your records.`);
    lines.push(`Write-Host "[4/5] BIOS status check..."`);
    lines.push(`$currentBios = (Get-WmiObject -Class Win32_BIOS).SMBIOSBIOSVersion`);
    lines.push(`Write-Host "Current BIOS: $currentBios"`);
    lines.push(`Write-Host "‚ö†Ô∏è MANUAL ACTION REQUIRED: Deploy BIOS ${latestBios} to ${hostname} separately"`);
    if(mfr.includes('dell')) {
      lines.push(`# When ready, run manually: .\\BIOS_${model.replace(/ /g,'_')}.exe /s /r /l=C:\\Logs\\bios_update.log`);
    }
    lines.push(``);
  }

  lines.push(`# ‚îÄ‚îÄ POWER MANAGEMENT (prevents Event 41 sleep/power-state crashes) ‚îÄ‚îÄ`);
  lines.push(`Write-Host "[5/5] Configuring power management..."`);
  lines.push(`powercfg /change standby-timeout-ac 0`);
  lines.push(`powercfg /change hibernate-timeout-ac 0`);
  lines.push(`powercfg /change monitor-timeout-ac 0`);
  lines.push(`powercfg /h off`);
  lines.push(`powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c`);
  lines.push(`Write-Host "Power management configured"`);
  lines.push(``);
  lines.push(`# ‚îÄ‚îÄ EVENT LOG SNAPSHOT ‚îÄ‚îÄ`);
  lines.push(`Write-Host "Saving crash event log..."`);
  lines.push(`Get-WinEvent -LogName System -MaxEvents 200 |`);
  lines.push(`  Where-Object {$_.Id -in 41,6008,1001} |`);
  lines.push(`  Select-Object TimeCreated,Id,Message |`);
  lines.push(`  Export-Csv "C:\\Logs\\CrashEvents_${hostname}.csv" -NoTypeInformation`);
  lines.push(`Write-Host "Log saved to C:\\Logs\\CrashEvents_${hostname}.csv"`);
  lines.push(``);
  lines.push(`# ‚îÄ‚îÄ SELF-CLEANUP: Remove scheduled task so this never runs again ‚îÄ‚îÄ`);
  lines.push(`Write-Host "Removing scheduled task (one-time run complete)..."`);
  lines.push(`Unregister-ScheduledTask -TaskName $taskName -Confirm:$false -ErrorAction SilentlyContinue`);
  lines.push(`Write-Host "‚úÖ Scheduled task removed ‚Äî this script will not run again automatically"`);
  lines.push(``);
  lines.push(`# ‚îÄ‚îÄ RE-RUN CRASH REPORTER: Push fresh status to dashboard ‚îÄ‚îÄ`);
  lines.push(`# This triggers the existing crash reporting pipeline:`);
  lines.push(`# Machine ‚Üí SendGrid email ‚Üí Power Automate ‚Üí SharePoint ‚Üí Dashboard refresh`);
  lines.push(`# The new report will reflect post-remediation state (fixes applied, fresh uptime, etc)`);
  lines.push(`# NOTE: Delete the OLD crash records in SharePoint manually after this runs,`);
  lines.push(`#       then the dashboard will show the clean post-remediation state.`);
  lines.push(`$ReporterScript = "C:\\ProgramData\\NewEraTech\\CrashReporter.ps1"`);
  lines.push(`if(Test-Path $ReporterScript) {`);
  lines.push(`  Write-Host "Running crash reporter to push fresh status to dashboard..."`);
  lines.push(`  & $ReporterScript`);
  lines.push(`  Write-Host "‚úÖ Fresh status report sent ‚Äî dashboard will update shortly"`);
  lines.push(`} else {`);
  lines.push(`  Write-Host "‚ö†Ô∏è Crash reporter not found at $ReporterScript ‚Äî run it manually to update dashboard"`);
  lines.push(`}`);
  lines.push(``);
  lines.push(`Stop-Transcript`);
  lines.push(`Write-Host ""`);
  lines.push(`Write-Host "=== All done. Log saved to $LogFile ==="`);
  lines.push(`Write-Host "Next step: Delete old crash records in SharePoint, then dashboard will show clean state."`);

  return lines.join('\n');
}

function downloadScript(hostname) {
  const script = generateFixScript(hostname);
  const blob = new Blob([script], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'TakedaRemediation_' + hostname + '.ps1';
  a.click();
}

function downloadAllScripts() {
  const machines = Object.keys(DATA.crashesPerMachine||{});
  if(!machines.length) return;
  // Download all as a combined master script
  const header = [
    '# ============================================================',
    '# Takeda DS Fleet Remediation ‚Äî Master Script',
    '# Includes all ' + machines.length + ' machines | Generated: ' + new Date().toLocaleDateString(),
    '#',
    '# HOW THIS WORKS:',
    '#   One file contains a unique remediation block for every machine.',
    '#   Each machine reads its own hostname and runs only its own block.',
    '#',
    '# DEPLOY VIA GOTO RESOLVE (3-step job):',
    '#   Step 1: File Distribution ‚Üí upload to C:\\Scripts\ ‚Üí Overwrite: ON',
    '#   Step 2: Wait ‚Üí 120 seconds',
    '#   Step 3: PowerShell execution ‚Üí paste the registration command from the dashboard',
    '#           (registers a ONE-TIME 3:00 AM task ‚Äî nothing runs immediately)',
    '#',
    '# WHAT HAPPENS AT 3:00 AM:',
    '#   - Machine detects hostname, runs only its specific fixes',
    '#   - Task removes itself after completion (runs once, never again)',
    '#   - Crash reporter re-runs to push fresh status to SharePoint/dashboard',
    '#   - Logs saved to C:\\Logs\\ on each machine',
    '#',
    '# AFTER 3AM ‚Äî DASHBOARD CLEANUP:',
    '#   1. Pull logs via GoTo Resolve File Manager (C:\\Logs\\)',
    '#   2. Delete old crash records in SharePoint (use Delete Records link in dashboard)',
    '#   3. Dashboard updates automatically with fresh post-remediation data',
    '#   NOTE: BIOS updates require manual deployment ‚Äî see ACTION REQUIRED in logs',
    '# ============================================================',
    ''
  ].join('\n');
  
  // Master deployment script that detects hostname and runs the right block
  let master = header;
  master += '$hostname = $env:COMPUTERNAME\n';
  master += 'Write-Host "Running remediation for: $hostname"\n\n';
  master += 'switch ($hostname) {\n';
  machines.forEach(h => {
    master += '  "' + h + '" {\n';
    master += generateFixScript(h).split('\n').map(l => '    ' + l).join('\n');
    master += '\n  }\n';
  });
  master += '  default { Write-Host "No remediation script found for $hostname" }\n';
  master += '}\n';
  
  const blob = new Blob([master], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'TakedaRemediation_ALL_MACHINES.ps1';
  a.click();
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadData();
// Refresh every 30 minutes
setInterval(loadData, 30*60*1000);
</script>
<footer style="margin-top:48px;padding:20px 24px;border-top:1px solid #1e293b;background:#060d1a">
  <div style="max-width:1400px;margin:0 auto;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:12px">
    <div style="color:#475569;font-size:11px;line-height:1.6">
      <span style="color:#64748b;font-weight:600">Designed by Justin Alexander</span>
      <span style="color:#334155"> ¬∑ ¬© 2026</span>
    </div>
    <div style="color:#374151;font-size:10px;text-align:right;line-height:1.6;max-width:600px">
      <span style="color:#6b7280;font-weight:600">‚ö† RESTRICTED ACCESS</span>
      <span style="color:#4b5563"> ‚Äî This system is for authorized personnel only. Unauthorized access, use, or disclosure of data contained herein is strictly prohibited and may constitute a violation of the Computer Fraud and Abuse Act (18 U.S.C. ¬ß 1030) and applicable state law. Violators may be subject to civil liability, criminal prosecution, substantial fines, and imprisonment. All access is logged and monitored.</span>
    </div>
  </div>
</footer>
</body>
</html>
